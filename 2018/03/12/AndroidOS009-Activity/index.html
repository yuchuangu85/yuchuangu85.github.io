<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android系统源码分析--Activity的finish过程 | 墨香博客</title><meta name="author" content="墨香"><meta name="copyright" content="墨香"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="上一篇我们分析了Activity的启动流程，由于代码量很大，还是没有分析的很详细，但是基本流程都出来了，更详细的东西还是要去看源码，源码在我文章的最后有给出，里面有我添加的详细的注释。这一章来分析Activity的finish过程，这个问题在两年前我去面试金山的时候曾经被问到过，那时候对源码基本没什么了解，所以当时根本是不了解的，今天我们就来分析一下finish的过程到底做了哪些处理，最后对Ac">
<meta property="og:type" content="article">
<meta property="og:title" content="Android系统源码分析--Activity的finish过程">
<meta property="og:url" content="http://www.codemx.cn/2018/03/12/AndroidOS009-Activity/index.html">
<meta property="og:site_name" content="墨香博客">
<meta property="og:description" content="上一篇我们分析了Activity的启动流程，由于代码量很大，还是没有分析的很详细，但是基本流程都出来了，更详细的东西还是要去看源码，源码在我文章的最后有给出，里面有我添加的详细的注释。这一章来分析Activity的finish过程，这个问题在两年前我去面试金山的时候曾经被问到过，那时候对源码基本没什么了解，所以当时根本是不了解的，今天我们就来分析一下finish的过程到底做了哪些处理，最后对Ac">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.codemx.cn/img/head.jpg">
<meta property="article:published_time" content="2018-03-12T06:55:07.000Z">
<meta property="article:modified_time" content="2024-07-12T16:41:32.275Z">
<meta property="article:author" content="墨香">
<meta property="article:tag" content="AndroidOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.codemx.cn/img/head.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.codemx.cn/2018/03/12/AndroidOS009-Activity/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android系统源码分析--Activity的finish过程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-13 00:41:32'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bg.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="墨香博客"><span class="site-name">墨香博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Android系统源码分析--Activity的finish过程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-03-12T06:55:07.000Z" title="发表于 2018-03-12 14:55:07">2018-03-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-12T16:41:32.275Z" title="更新于 2024-07-13 00:41:32">2024-07-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AndroidOS/">AndroidOS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Android系统源码分析--Activity的finish过程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><blockquote>
<p>上一篇我们分析了Activity的启动流程，由于代码量很大，还是没有分析的很详细，但是基本流程都出来了，更详细的东西还是要去看源码，源码在我文章的最后有给出，里面有我添加的详细的注释。这一章来分析Activity的finish过程，这个问题在两年前我去面试金山的时候曾经被问到过，那时候对源码基本没什么了解，所以当时根本是不了解的，今天我们就来分析一下finish的过程到底做了哪些处理，最后对Activity的整个启动过程以及finish过程绘制流程图，以方便我们记忆。</p>
</blockquote>
<span id="more"></span>

<h2 id="finish代码分析"><a href="#finish代码分析" class="headerlink" title="finish代码分析"></a>finish代码分析</h2><p>首先先贴一张时序图：</p>
<p><img src="/images/AndroidOS/007Activity/ActivityFinish.jpg" alt="Activity启动时序图"></p>
<p>Activity的finish方法就是调用的父类的finish方法：</p>
<h4 id="Step1-Activity-finish"><a href="#Step1-Activity-finish" class="headerlink" title="Step1.Activity.finish"></a>Step1.Activity.finish</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">()</span> &#123;</span><br><span class="line">    finish(DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用finish方法，传入参数DONT_FINISH_TASK_WITH_ACTIVITY，这个参数是在finish掉Activity的时候不finish掉Task。</p>
<h4 id="Step2-Activity-finish"><a href="#Step2-Activity-finish" class="headerlink" title="Step2.Activity.finish"></a>Step2.Activity.finish</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">(<span class="type">int</span> finishTask)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">            <span class="keyword">if</span> (ActivityManagerNative.getDefault()</span><br><span class="line">                    .finishActivity(mToken, resultCode, resultData, finishTask)) &#123;</span><br><span class="line">                mFinished = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ActivityManagerNative.getDefault()方法其实我们在前面文章提到过，得到的是AMP（ActivityManagerProxy）。</p>
<h4 id="Step3-AMP-finishActivity"><a href="#Step3-AMP-finishActivity" class="headerlink" title="Step3.AMP.finishActivity"></a>Step3.AMP.finishActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">finishActivity</span><span class="params">(IBinder token, <span class="type">int</span> resultCode, Intent resultData, <span class="type">int</span> finishTask)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    mRemote.transact(FINISH_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Binder调用AMS的finishActivity方法。</p>
<h4 id="Step4-AMS-finishActivity"><a href="#Step4-AMS-finishActivity" class="headerlink" title="Step4.AMS.finishActivity"></a>Step4.AMS.finishActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">finishActivity</span><span class="params">(IBinder token, <span class="type">int</span> resultCode, Intent resultData,</span></span><br><span class="line"><span class="params">                                    <span class="type">int</span> finishTask)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 根据token（IBinder）获取Activity的对象封装ActivityRecord</span></span><br><span class="line">        <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> ActivityRecord.isInStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Keep track of the root activity of the task before we finish it</span></span><br><span class="line">        <span class="type">TaskRecord</span> <span class="variable">tr</span> <span class="operator">=</span> r.task;</span><br><span class="line">        <span class="comment">// 从栈底部获取第一没有被finish的Activity对象封装</span></span><br><span class="line">        <span class="type">ActivityRecord</span> <span class="variable">rootR</span> <span class="operator">=</span> tr.getRootActivity();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (mController != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Find the first activity that is not finishing.</span></span><br><span class="line">            <span class="comment">// 获取第一个没有被回收的Activity</span></span><br><span class="line">            <span class="type">ActivityRecord</span> <span class="variable">next</span> <span class="operator">=</span> r.task.stack.topRunningActivityLocked(token, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="literal">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 传入的finishTask是DONT_FINISH_TASK_WITH_ACTIVITY，所以下面参数是false</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">finishWithRootActivity</span> <span class="operator">=</span></span><br><span class="line">                    finishTask == Activity.FINISH_TASK_WITH_ROOT_ACTIVITY;</span><br><span class="line">            <span class="comment">// 这里if中条件为false所以走else语句</span></span><br><span class="line">            <span class="keyword">if</span> (finishTask == Activity.FINISH_TASK_WITH_ACTIVITY</span><br><span class="line">                    || (finishWithRootActivity &amp;&amp; r == rootR)) &#123;</span><br><span class="line">                res = removeTaskByIdLocked(tr.taskId, <span class="literal">false</span>, finishWithRootActivity);</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                res = tr.stack.requestFinishActivityLocked(token, resultCode,</span><br><span class="line">                        resultData, <span class="string">&quot;app-request&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面try语句中会走else语句中的方法也就是ActivityStack.requestFinishActivityLocked</p>
<h4 id="Step5-ActivityStack-requestFinishActivityLocked"><a href="#Step5-ActivityStack-requestFinishActivityLocked" class="headerlink" title="Step5.ActivityStack.requestFinishActivityLocked"></a>Step5.ActivityStack.requestFinishActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">requestFinishActivityLocked</span><span class="params">(IBinder token, <span class="type">int</span> resultCode,</span></span><br><span class="line"><span class="params">                                          Intent resultData, String reason, <span class="type">boolean</span> oomAdj)</span> &#123;</span><br><span class="line">    <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> isInStackLocked(token);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    finishActivityLocked(r, resultCode, resultData, reason, oomAdj);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用finishActivityLocked方法</p>
<h4 id="Step6-ActivityStack-finishActivityLocked"><a href="#Step6-ActivityStack-finishActivityLocked" class="headerlink" title="Step6.ActivityStack.finishActivityLocked"></a>Step6.ActivityStack.finishActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">finishActivityLocked</span><span class="params">(ActivityRecord r, <span class="type">int</span> resultCode, Intent resultData,</span></span><br><span class="line"><span class="params">                                   String reason, <span class="type">boolean</span> oomAdj)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.finishing) &#123;<span class="comment">// 如果要清理的的正在finish，则不需要再清理</span></span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Duplicate finish request for &quot;</span> + r);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标记开始finish</span></span><br><span class="line">    r.makeFinishingLocked();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止键盘分发事件</span></span><br><span class="line">    r.pauseKeyDispatchingLocked();</span><br><span class="line"></span><br><span class="line">    adjustFocusedActivityLocked(r, <span class="string">&quot;finishActivity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    finishActivityResultsLocked(r, resultCode, resultData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果任务中没有了Activity要结束任务</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">endTask</span> <span class="operator">=</span> index &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">transit</span> <span class="operator">=</span> endTask ? TRANSIT_TASK_CLOSE : TRANSIT_ACTIVITY_CLOSE;</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity == r) &#123;<span class="comment">// 如果当前显示的Activity就是要结束的Activity</span></span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mPausingActivity == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 开始暂停Activity</span></span><br><span class="line">            startPausingLocked(<span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (endTask) &#123;<span class="comment">// 如果任务中没有了Activity，则移除任务</span></span><br><span class="line">            mStackSupervisor.removeLockedTaskLocked(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != ActivityState.PAUSING) &#123;<span class="comment">// 如果要移除的Activity不是Pausing状态并且不是正在显示的Activity</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> finishCurrentActivityLocked(r, (r.visible || r.nowVisible) ?</span><br><span class="line">                FINISH_AFTER_VISIBLE : FINISH_AFTER_PAUSE, oomAdj) == <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里首先调用ActivityRecord.makeFinishingLocked标记开始结束Activity，然后调用ActivityRecord.pauseKeyDispatchingLocked方法停止键盘事件分发。然后调用adjustFocusedActivityLocked方法，调整Activity的焦点状体。</p>
<h4 id="Step7-ActivityStack-adjustFocusedActivityLocked"><a href="#Step7-ActivityStack-adjustFocusedActivityLocked" class="headerlink" title="Step7.ActivityStack.adjustFocusedActivityLocked"></a>Step7.ActivityStack.adjustFocusedActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">adjustFocusedActivityLocked</span><span class="params">(ActivityRecord r, String reason)</span> &#123;</span><br><span class="line">     <span class="comment">// 如果当前栈没有焦点，或者当前Activity也不是当前有焦点的Activity，返回</span></span><br><span class="line">     <span class="keyword">if</span> (!mStackSupervisor.isFocusedStack(<span class="built_in">this</span>) || mService.mFocusedActivity != r) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取栈顶正在运行的Activity</span></span><br><span class="line">     <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">next</span> <span class="operator">=</span> topRunningActivityLocked();</span><br><span class="line">     <span class="keyword">final</span> <span class="type">String</span> <span class="variable">myReason</span> <span class="operator">=</span> reason + <span class="string">&quot; adjustFocus&quot;</span>;</span><br><span class="line">     <span class="keyword">if</span> (next != r) &#123;<span class="comment">// 如果栈顶正在运行的不是当前要结束的Activity</span></span><br><span class="line">         <span class="keyword">if</span> (next != <span class="literal">null</span> &amp;&amp; StackId.keepFocusInStackIfPossible(mStackId) &amp;&amp; isFocusable()) &#123;</span><br><span class="line">             mService.setFocusedActivityLocked(next, myReason);</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">final</span> <span class="type">TaskRecord</span> <span class="variable">task</span> <span class="operator">=</span> r.task;</span><br><span class="line">             <span class="keyword">if</span> (r.frontOfTask &amp;&amp; task == topTask() &amp;&amp; task.isOverHomeStack()) &#123;</span><br><span class="line">                 <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskToReturnTo</span> <span class="operator">=</span> task.getTaskToReturnTo();</span><br><span class="line">                 <span class="keyword">if</span> (!mFullscreen</span><br><span class="line">                         &amp;&amp; adjustFocusToNextFocusableStackLocked(taskToReturnTo, myReason)) &#123;</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">if</span> (mStackSupervisor.moveHomeStackTaskToTop(taskToReturnTo, myReason)) &#123;</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mService.setFocusedActivityLocked(mStackSupervisor.topRunningActivityLocked(), myReason);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>当前Activity要finish掉，就找找到下一个应该获取焦点的Activity，在该Activity被finish掉之后显示出来。</p>
<h4 id="Step8-ActivityStack-finishActivityResultsLocked"><a href="#Step8-ActivityStack-finishActivityResultsLocked" class="headerlink" title="Step8.ActivityStack.finishActivityResultsLocked"></a>Step8.ActivityStack.finishActivityResultsLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">finishActivityResultsLocked</span><span class="params">(ActivityRecord r, <span class="type">int</span> resultCode, Intent resultData)</span> &#123;</span><br><span class="line">     <span class="comment">// send the result</span></span><br><span class="line">     <span class="type">ActivityRecord</span> <span class="variable">resultTo</span> <span class="operator">=</span> r.resultTo;</span><br><span class="line">     <span class="keyword">if</span> (resultTo != <span class="literal">null</span>) &#123;</span><br><span class="line">         ...</span><br><span class="line">         resultTo.addResultLocked(r, r.resultWho, r.requestCode, resultCode,</span><br><span class="line">                 resultData);</span><br><span class="line">         r.resultTo = <span class="literal">null</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS, <span class="string">&quot;No result destination from &quot;</span> + r);</span><br><span class="line"></span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>如果要接收Result的Activity描述对象ActivityRecord还存在，就将result相关信息封装成ActivityResult对象放到ActivityResult列表中保存起来。然后置空该Activity对应的ActivityRecord对象中的信息。</p>
<h4 id="Step9-ActivityStack-startPausingLocked"><a href="#Step9-ActivityStack-startPausingLocked" class="headerlink" title="Step9.ActivityStack.startPausingLocked"></a>Step9.ActivityStack.startPausingLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">startPausingLocked</span><span class="params">(<span class="type">boolean</span> userLeaving, <span class="type">boolean</span> uiSleeping,</span></span><br><span class="line"><span class="params">                                 ActivityRecord resuming, <span class="type">boolean</span> dontWait)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPausingActivity != <span class="literal">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">&quot;Going to pause when pause is already pending for &quot;</span> + mPausingActivity</span><br><span class="line">                + <span class="string">&quot; state=&quot;</span> + mPausingActivity.state);</span><br><span class="line">        <span class="keyword">if</span> (!mService.isSleepingLocked()) &#123;<span class="comment">// 如果没有在睡眠，则完成Pause状态</span></span><br><span class="line">            completePauseLocked(<span class="literal">false</span>, resuming);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// prev指向源Activity</span></span><br><span class="line">    <span class="type">ActivityRecord</span> <span class="variable">prev</span> <span class="operator">=</span> mResumedActivity;</span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resuming == <span class="literal">null</span>) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">&quot;Trying to pause when nothing is resumed&quot;</span>);</span><br><span class="line">            mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mActivityContainer.mParentActivity == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Top level stack, not a child. Look for child stacks.</span></span><br><span class="line">        <span class="comment">// 暂停所有子栈的Activity</span></span><br><span class="line">        mStackSupervisor.pauseChildStacks(prev, userLeaving, uiSleeping, resuming, dontWait);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 改变状态</span></span><br><span class="line">    prev.state = ActivityState.PAUSING;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 获取正在启动的Activity组件</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">next</span> <span class="operator">=</span> mStackSupervisor.topRunningActivityLocked();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="literal">null</span> &amp;&amp; prev.app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="comment">// 通知源Activity组件，暂停源Activity以便有机会执行一些数据保存操作，</span></span><br><span class="line">            <span class="comment">// 这里如果目标sdk&lt;11会调用onSaveInstanceState，然后调用onPause</span></span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                    userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要是在finish之前pause该Activity，如果状态正常会调用schedulePauseActivity方法，最终调用Activity的onPause方法，这个过程我们在前面讲过几次了，这里就不再分析，比较简单。我们接着看核心的代码。</p>
<h4 id="Step10-ActivityStack-finishCurrentActivityLocked"><a href="#Step10-ActivityStack-finishCurrentActivityLocked" class="headerlink" title="Step10.ActivityStack.finishCurrentActivityLocked"></a>Step10.ActivityStack.finishCurrentActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ActivityRecord <span class="title function_">finishCurrentActivityLocked</span><span class="params">(ActivityRecord r, <span class="type">int</span> mode, <span class="type">boolean</span> oomAdj)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果当前要finish的Activity正在显示，而复用的Activity还没有显示，那么延迟finish，</span></span><br><span class="line">    <span class="comment">// 直到复用Activity显示</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取顶部正在运行的Activity</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">next</span> <span class="operator">=</span> mStackSupervisor.topRunningActivityLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是显示后在finish，并且要结束的正在显示或者将要显示，并且顶部运行的存在而且没有显示</span></span><br><span class="line">    <span class="keyword">if</span> (mode == FINISH_AFTER_VISIBLE &amp;&amp; (r.visible || r.nowVisible)</span><br><span class="line">            &amp;&amp; next != <span class="literal">null</span> &amp;&amp; !next.nowVisible) &#123;</span><br><span class="line">        <span class="comment">// 如果当前要结束的Activity不在正在停止列表中则添加到停止列表中</span></span><br><span class="line">        <span class="keyword">if</span> (!mStackSupervisor.mStoppingActivities.contains(r)) &#123;</span><br><span class="line">            addToStopping(r, <span class="literal">false</span> <span class="comment">/* immediate */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure the record is cleaned out of other places.</span></span><br><span class="line">    <span class="comment">// 从各个列表中清理这个将要被finish的Activity</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityState</span> <span class="variable">prevState</span> <span class="operator">=</span> r.state;<span class="comment">// 存储清理之前的状态</span></span><br><span class="line">    r.state = ActivityState.FINISHING;<span class="comment">// 设置为正在finish状态</span></span><br><span class="line">    <span class="comment">// 判断当前正在清理的Activity是否在当前获取焦点的栈中</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">finishingActivityInNonFocusedStack</span></span><br><span class="line">            <span class="operator">=</span> r.task.stack != mStackSupervisor.getFocusedStack()</span><br><span class="line">            &amp;&amp; prevState == ActivityState.PAUSED &amp;&amp; mode == FINISH_AFTER_VISIBLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mode == FINISH_IMMEDIATELY</span><br><span class="line">            || (prevState == ActivityState.PAUSED</span><br><span class="line">            &amp;&amp; (mode == FINISH_AFTER_PAUSE || mStackId == PINNED_STACK_ID))</span><br><span class="line">            || finishingActivityInNonFocusedStack</span><br><span class="line">            || prevState == ActivityState.STOPPED</span><br><span class="line">            || prevState == ActivityState.INITIALIZING) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 销毁Activity</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">activityRemoved</span> <span class="operator">=</span> destroyActivityLocked(r, <span class="literal">true</span>, <span class="string">&quot;finish-imm&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> activityRemoved ? <span class="literal">null</span> : r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是开始销毁Activity，首先要保存状态，然后标记开始finish，然后调用destroyActivityLocked方法开始销毁。</p>
<h4 id="Step11-ActivityStack-destroyActivityLocked"><a href="#Step11-ActivityStack-destroyActivityLocked" class="headerlink" title="Step11.ActivityStack.destroyActivityLocked"></a>Step11.ActivityStack.destroyActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">destroyActivityLocked</span><span class="params">(ActivityRecord r, <span class="type">boolean</span> removeFromApp, String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理Activity</span></span><br><span class="line">    cleanUpActivityLocked(r, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">hadApp</span> <span class="operator">=</span> r.app != <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hadApp) &#123;</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">skipDestroy</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.app.thread.scheduleDestroyActivity(r.appToken, r.finishing,</span><br><span class="line">                    r.configChangeFlags);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> removedFromHistory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要有两部操作，第一步是cleanUpActivityLocked，第二步是scheduleDestroyActivity。我们先看第一步。</p>
<h4 id="Step12-ActivityStack-cleanUpActivityLocked"><a href="#Step12-ActivityStack-cleanUpActivityLocked" class="headerlink" title="Step12.ActivityStack.cleanUpActivityLocked"></a>Step12.ActivityStack.cleanUpActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">cleanUpActivityLocked</span><span class="params">(ActivityRecord r, <span class="type">boolean</span> cleanServices,</span></span><br><span class="line"><span class="params">                                 <span class="type">boolean</span> setState)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity == r) &#123;</span><br><span class="line">        mResumedActivity = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mPausingActivity == r) &#123;</span><br><span class="line">        mPausingActivity = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mService.resetFocusedActivityIfNeededLocked(r);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure this record is no longer in the pending finishes list.</span></span><br><span class="line">    <span class="comment">// This could happen, for example, if we are trimming activities</span></span><br><span class="line">    <span class="comment">// down to the max limit while they are still waiting to finish.</span></span><br><span class="line">    mStackSupervisor.mFinishingActivities.remove(r);</span><br><span class="line">    mStackSupervisor.mWaitingVisibleActivities.remove(r);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cleanServices) &#123;<span class="comment">// 是否清理服务</span></span><br><span class="line">        cleanUpActivityServicesLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是将指向该销毁的Activity的引用都置空，进行释放，然后将该Activity描述对象从列表中移除该对象，最后是判断是否清理服务，其实主要是绑定该Activity的服务，如果有绑定则解除绑定。</p>
<h4 id="Step13-ActivityManagerService-resetFocusedActivityIfNeededLocked"><a href="#Step13-ActivityManagerService-resetFocusedActivityIfNeededLocked" class="headerlink" title="Step13.ActivityManagerService.resetFocusedActivityIfNeededLocked"></a>Step13.ActivityManagerService.resetFocusedActivityIfNeededLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重新设置获取焦点的Activity，如果被清理的不是获取焦点的，那么不处理，否则将焦点移动到另外一个Activity</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">resetFocusedActivityIfNeededLocked</span><span class="params">(ActivityRecord goingAway)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to move focus to another activity if possible.</span></span><br><span class="line">    <span class="comment">// 如果允许，将焦点移动到另外一个Activity</span></span><br><span class="line">    <span class="keyword">if</span> (setFocusedActivityLocked(</span><br><span class="line">            focusedStack.topRunningActivityLocked(), <span class="string">&quot;resetFocusedActivityIfNeeded&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用setFocusedActivityLocked方法判断该Activity是不是允许允许将焦点移除。</p>
<h4 id="Step14-ActivityManagerService-setFocusedActivityLocked"><a href="#Step14-ActivityManagerService-setFocusedActivityLocked" class="headerlink" title="Step14.ActivityManagerService.setFocusedActivityLocked"></a>Step14.ActivityManagerService.setFocusedActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">setFocusedActivityLocked</span><span class="params">(ActivityRecord r, String reason)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span> || mFocusedActivity == r) &#123;<span class="comment">// 如果传入的焦点Activity不存在或者就是显示在有焦点的Activity则不需要处理了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r.isFocusable()) &#123;<span class="comment">// 如果没有获取焦点，返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取之前有焦点的Activity</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">last</span> <span class="operator">=</span> mFocusedActivity;</span><br><span class="line">    mFocusedActivity = r;<span class="comment">// 设置传入的Activity为当前焦点Activity</span></span><br><span class="line">    <span class="keyword">if</span> (r.task.isApplicationTask()) &#123;<span class="comment">// 当前焦点Activity所在任务是应用任务（不是桌面和最近应用界面）</span></span><br><span class="line">        <span class="keyword">if</span> (mCurAppTimeTracker != r.appTimeTracker) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startTimeTrackingFocusedActivityLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.appTimeTracker = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 将要启动的Activity移动到前台</span></span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.moveActivityStackToFront(r, reason + <span class="string">&quot; setFocusedActivity&quot;</span>)) &#123;</span><br><span class="line">        mWindowManager.setFocusedApp(r.appToken, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里看一下注释，主要是判断该Activity是否有焦点，是否允许切换焦点。因此要结束的Activity就要把焦点释放掉。</p>
<h4 id="Step15-ActivityStack-cleanUpActivityServicesLocked"><a href="#Step15-ActivityStack-cleanUpActivityServicesLocked" class="headerlink" title="Step15.ActivityStack.cleanUpActivityServicesLocked"></a>Step15.ActivityStack.cleanUpActivityServicesLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">cleanUpActivityServicesLocked</span><span class="params">(ActivityRecord r)</span> &#123;</span><br><span class="line">    <span class="comment">// Throw away any services that have been bound by this activity.</span></span><br><span class="line">    <span class="keyword">if</span> (r.connections != <span class="literal">null</span>) &#123;</span><br><span class="line">        Iterator&lt;ConnectionRecord&gt; it = r.connections.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="type">ConnectionRecord</span> <span class="variable">c</span> <span class="operator">=</span> it.next();</span><br><span class="line">            mService.mServices.removeConnectionLocked(c, <span class="literal">null</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        r.connections = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面我们提到这个方法主要是释放绑定的服务，如果没有则不需要释放。下面我们回到Step11中提到的第二步。</p>
<h4 id="Step16-ApplicationThreadNative-scheduleDestroyActivity"><a href="#Step16-ApplicationThreadNative-scheduleDestroyActivity" class="headerlink" title="Step16.ApplicationThreadNative.scheduleDestroyActivity"></a>Step16.ApplicationThreadNative.scheduleDestroyActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">scheduleDestroyActivity</span><span class="params">(IBinder token, <span class="type">boolean</span> finishing,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> configChanges)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    mRemote.transact(SCHEDULE_FINISH_ACTIVITY_TRANSACTION, data, <span class="literal">null</span>,</span><br><span class="line">            IBinder.FLAG_ONEWAY);</span><br><span class="line">    ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个很熟悉了。</p>
<h4 id="Step17-ApplicationThread-scheduleDestroyActivity"><a href="#Step17-ApplicationThread-scheduleDestroyActivity" class="headerlink" title="Step17.ApplicationThread.scheduleDestroyActivity"></a>Step17.ApplicationThread.scheduleDestroyActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">scheduleDestroyActivity</span><span class="params">(IBinder token, <span class="type">boolean</span> finishing,</span></span><br><span class="line"><span class="params">                                          <span class="type">int</span> configChanges)</span> &#123;</span><br><span class="line">    sendMessage(H.DESTROY_ACTIVITY, token, finishing ? <span class="number">1</span> : <span class="number">0</span>,</span><br><span class="line">            configChanges);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过发送消息到Handler中来处理。</p>
<h4 id="Step18-ActivityThread-H-handleMessage"><a href="#Step18-ActivityThread-H-handleMessage" class="headerlink" title="Step18.ActivityThread.H.handleMessage"></a>Step18.ActivityThread.H.handleMessage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">case</span> DESTROY_ACTIVITY:</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityDestroy&quot;</span>);</span><br><span class="line">            handleDestroyActivity((IBinder) msg.obj, msg.arg1 != <span class="number">0</span>,</span><br><span class="line">                    msg.arg2, <span class="literal">false</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h4 id="Step19-ActivityThread-handleDestroyActivity"><a href="#Step19-ActivityThread-handleDestroyActivity" class="headerlink" title="Step19.ActivityThread.handleDestroyActivity"></a>Step19.ActivityThread.handleDestroyActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDestroyActivity</span><span class="params">(IBinder token, <span class="type">boolean</span> finishing,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> configChanges, <span class="type">boolean</span> getNonConfigInstance)</span> &#123;</span><br><span class="line">    <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> performDestroyActivity(token, finishing,</span><br><span class="line">            configChanges, getNonConfigInstance);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManagerNative.getDefault().activityDestroyed(token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mSomeActivitiesChanged = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step20-ActivityThread-performDestroyActivity"><a href="#Step20-ActivityThread-performDestroyActivity" class="headerlink" title="Step20.ActivityThread.performDestroyActivity"></a>Step20.ActivityThread.performDestroyActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ActivityClientRecord <span class="title function_">performDestroyActivity</span><span class="params">(IBinder token, <span class="type">boolean</span> finishing,</span></span><br><span class="line"><span class="params">                                                    <span class="type">int</span> configChanges, <span class="type">boolean</span> getNonConfigInstance)</span> &#123;</span><br><span class="line">    <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> mActivities.get(token);</span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Activity</span>&gt; activityClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Performing finish of &quot;</span> + r);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        performPauseActivityIfNeeded(r, <span class="string">&quot;destroy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.activity.mCalled = <span class="literal">false</span>;</span><br><span class="line">            mInstrumentation.callActivityOnDestroy(r.activity);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行performPauseActivityIfNeeded，然后执行Instrumentation.callActivityOnDestroy方法结束。</p>
<h4 id="Step21-ActivityThread-performPauseActivityIfNeeded"><a href="#Step21-ActivityThread-performPauseActivityIfNeeded" class="headerlink" title="Step21.ActivityThread.performPauseActivityIfNeeded"></a>Step21.ActivityThread.performPauseActivityIfNeeded</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performPauseActivityIfNeeded</span><span class="params">(ActivityClientRecord r, String reason)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.paused) &#123;</span><br><span class="line">        <span class="comment">// You are already paused silly...</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        r.activity.mCalled = <span class="literal">false</span>;</span><br><span class="line">        mInstrumentation.callActivityOnPause(r.activity);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    r.paused = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果已经paused了，则直接返回，否则调用Instrumentation.callActivityOnPause方法。</p>
<h4 id="Step22-Instrumentation-callActivityOnPause"><a href="#Step22-Instrumentation-callActivityOnPause" class="headerlink" title="Step22.Instrumentation.callActivityOnPause"></a>Step22.Instrumentation.callActivityOnPause</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callActivityOnPause</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    activity.performPause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step23-Activity-performPause"><a href="#Step23-Activity-performPause" class="headerlink" title="Step23.Activity.performPause"></a>Step23.Activity.performPause</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performPause</span><span class="params">()</span> &#123;</span><br><span class="line">    ..</span><br><span class="line">    onPause();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step24-Activity-onPause"><a href="#Step24-Activity-onPause" class="headerlink" title="Step24.Activity.onPause"></a>Step24.Activity.onPause</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_LIFECYCLE) Slog.v(TAG, <span class="string">&quot;onPause &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">    getApplication().dispatchActivityPaused(<span class="built_in">this</span>);</span><br><span class="line">    mCalled = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就是调用了Activity的onPause方法了。</p>
<h4 id="Step25-Activity-performStop"><a href="#Step25-Activity-performStop" class="headerlink" title="Step25.Activity.performStop"></a>Step25.Activity.performStop</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performStop</span><span class="params">(<span class="type">boolean</span> preserveWindow)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mStopped) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        mCalled = <span class="literal">false</span>;</span><br><span class="line">        mInstrumentation.callActivityOnStop(<span class="built_in">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    mResumed = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用Instrumentation.callActivityOnStop方法，这里本来还有Fragment的处理，我略掉了，自己看看。</p>
<h4 id="Step26-Instrumentation-callActivityOnStop"><a href="#Step26-Instrumentation-callActivityOnStop" class="headerlink" title="Step26.Instrumentation.callActivityOnStop"></a>Step26.Instrumentation.callActivityOnStop</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callActivityOnStop</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    activity.onStop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了Activity的onStop方法。代码略了。</p>
<h4 id="Step28-Instrumentation-callActivityOnDestroy"><a href="#Step28-Instrumentation-callActivityOnDestroy" class="headerlink" title="Step28.Instrumentation.callActivityOnDestroy"></a>Step28.Instrumentation.callActivityOnDestroy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callActivityOnDestroy</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">   activity.performDestroy();</span><br><span class="line">   </span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用Activity的performDestroy方法</p>
<h4 id="Step29-Activity-performDestroy"><a href="#Step29-Activity-performDestroy" class="headerlink" title="Step29.Activity.performDestroy"></a>Step29.Activity.performDestroy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    onDestroy();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里终于看到了onDestroy方法。这里还有Fragment的处理，我没有显示出来，自己看看。我们再回到Step20中的第二个方法中。</p>
<h4 id="Step31-AMP-activityDestroyed"><a href="#Step31-AMP-activityDestroyed" class="headerlink" title="Step31.AMP.activityDestroyed"></a>Step31.AMP.activityDestroyed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">activityDestroyed</span><span class="params">(IBinder token)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    mRemote.transact(ACTIVITY_DESTROYED_TRANSACTION, data, reply, IBinder.FLAG_ONEWAY);</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用AMS中的activityDestroyed方法。</p>
<h4 id="Step32-AMS-activityDestroyed"><a href="#Step32-AMS-activityDestroyed" class="headerlink" title="Step32.AMS.activityDestroyed"></a>Step32.AMS.activityDestroyed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">activityDestroyed</span><span class="params">(IBinder token)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="type">ActivityStack</span> <span class="variable">stack</span> <span class="operator">=</span> ActivityRecord.getStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (stack != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack.activityDestroyedLocked(token, <span class="string">&quot;activityDestroyed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step33-ActivityStack-activityDestroyedLocked"><a href="#Step33-ActivityStack-activityDestroyedLocked" class="headerlink" title="Step33.ActivityStack.activityDestroyedLocked"></a>Step33.ActivityStack.activityDestroyedLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">activityDestroyedLocked</span><span class="params">(IBinder token, String reason)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> ActivityRecord.forTokenLocked(token);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isInStackLocked(r) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.state == ActivityState.DESTROYING) &#123;</span><br><span class="line">                cleanUpActivityLocked(r, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">                removeActivityFromHistoryLocked(r, <span class="literal">null</span>, reason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要是两步，第一个是调用cleanUpActivityLocked方法，清理Activity，前面Step12我们分析过了，不再分析。然后是调用removeActivityFromHistoryLocked方法，就是将该结束的Activity从历史列表中删除.</p>
<h4 id="Step35-ActivityStack-removeActivityFromHistoryLocked"><a href="#Step35-ActivityStack-removeActivityFromHistoryLocked" class="headerlink" title="Step35.ActivityStack.removeActivityFromHistoryLocked"></a>Step35.ActivityStack.removeActivityFromHistoryLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从历史记录移除</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeActivityFromHistoryLocked</span><span class="params">(</span></span><br><span class="line"><span class="params">        ActivityRecord r, TaskRecord oldTop, String reason)</span> &#123;</span><br><span class="line">    mStackSupervisor.removeChildActivityContainers(r);</span><br><span class="line">    finishActivityResultsLocked(r, Activity.RESULT_CANCELED, <span class="literal">null</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="literal">null</span> &amp;&amp; task.removeActivity(r)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStackSupervisor.isFocusedStack(<span class="built_in">this</span>) &amp;&amp; task == topTask &amp;&amp;</span><br><span class="line">                task.isOverHomeStack()) &#123;</span><br><span class="line">            mStackSupervisor.moveHomeStackTaskToTop(task.getTaskToReturnTo(), reason);</span><br><span class="line">        &#125;</span><br><span class="line">        removeTask(task, reason);</span><br><span class="line">    &#125;</span><br><span class="line">    cleanUpActivityServicesLocked(r);</span><br><span class="line">    r.removeUriPermissionsLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用finishActivityResultsLocked方法处理Result，前面提到了。调用ActivityStackSupervisor.moveHomeStackTaskToTop将Home属性的Activity所在任务栈放到顶部。调用cleanUpActivityServicesLocked清理绑定的服务。</p>
<h4 id="Step39-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#Step39-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="Step39.ActivityStackSupervisor.resumeFocusedStackTopActivityLocked"></a>Step39.ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">resumeFocusedStackTopActivityLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> resumeFocusedStackTopActivityLocked(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们在上一章Activity的启动时已经分析过了。这里不再分析。到这里Activity的finish就分析完了，从这里我们主要学到的是finish的过程，以及finish过程中系统做了哪些处理，我们在写代码过程中应该做那些处理。</p>
<h2 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h2><p><img src="/images/AndroidOS/007Activity/ActivityFlow.jpg" alt="Activity启动时序图"></p>
<h2 id="代码地址："><a href="#代码地址：" class="headerlink" title="代码地址："></a>代码地址：</h2><p>直接拉取导入开发工具（Intellij idea或者Android studio）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yuchuangu85/Android_Framework_Source">Android_Framework_Source</a></p>
<h2 id="注"><a href="#注" class="headerlink" title="注"></a>注</h2><p>Android开发群：192508518</p>
<p>微信公众账号：Code-MX<br><img width="240" src="/images/codemx/qr_code_mx.jpg"/></p>
<p>注：本文原创，转载请注明出处，多谢。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://www.codemx.cn">墨香</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://www.codemx.cn/2018/03/12/AndroidOS009-Activity/">http://www.codemx.cn/2018/03/12/AndroidOS009-Activity/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.codemx.cn" target="_blank">墨香博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AndroidOS/">AndroidOS</a></div><div class="post-share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2018/04/24/AndroidOS010-Service/" title="Android系统源码分析--Service启动流程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android系统源码分析--Service启动流程</div></div></a><a class="next-post pull-right" href="/2018/01/26/AndroidOS008-Activity/" title="Android系统源码分析--Activity启动过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android系统源码分析--Activity启动过程</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2017/06/03/AndroidOS001/" title="IntelliJ IDEA导入Android源码"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-06-03</div><div class="title">IntelliJ IDEA导入Android源码</div></div></a><a href="/2017/06/05/AndroidOS002-Context/" title="Android系统源码分析--Context"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-06-05</div><div class="title">Android系统源码分析--Context</div></div></a><a href="/2017/07/12/AndroidOS003-SystemServer/" title="Android系统源码分析--Zygote和SystemServer启动过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-07-12</div><div class="title">Android系统源码分析--Zygote和SystemServer启动过程</div></div></a><a href="/2017/07/13/AndroidOS004-HandleMessageLooper/" title="Android系统源码分析--消息循环机制"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-07-13</div><div class="title">Android系统源码分析--消息循环机制</div></div></a><a href="/2017/12/21/AndroidOS006-Broadcast1/" title="Android系统源码分析--Broadcast注册和注销"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-21</div><div class="title">Android系统源码分析--Broadcast注册和注销</div></div></a><a href="/2018/01/26/AndroidOS008-Activity/" title="Android系统源码分析--Activity启动过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-01-26</div><div class="title">Android系统源码分析--Activity启动过程</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">墨香</div><div class="author-info-description">因为兴趣所以选择，因为选择所以坚持。</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yuchuangu85"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/yuchuangu85" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yuchuangu85@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">路虽远，行则将至；事虽难，做则可成。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#finish%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">finish代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Step1-Activity-finish"><span class="toc-number">1.0.1.</span> <span class="toc-text">Step1.Activity.finish</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step2-Activity-finish"><span class="toc-number">1.0.2.</span> <span class="toc-text">Step2.Activity.finish</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step3-AMP-finishActivity"><span class="toc-number">1.0.3.</span> <span class="toc-text">Step3.AMP.finishActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step4-AMS-finishActivity"><span class="toc-number">1.0.4.</span> <span class="toc-text">Step4.AMS.finishActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step5-ActivityStack-requestFinishActivityLocked"><span class="toc-number">1.0.5.</span> <span class="toc-text">Step5.ActivityStack.requestFinishActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step6-ActivityStack-finishActivityLocked"><span class="toc-number">1.0.6.</span> <span class="toc-text">Step6.ActivityStack.finishActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step7-ActivityStack-adjustFocusedActivityLocked"><span class="toc-number">1.0.7.</span> <span class="toc-text">Step7.ActivityStack.adjustFocusedActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step8-ActivityStack-finishActivityResultsLocked"><span class="toc-number">1.0.8.</span> <span class="toc-text">Step8.ActivityStack.finishActivityResultsLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step9-ActivityStack-startPausingLocked"><span class="toc-number">1.0.9.</span> <span class="toc-text">Step9.ActivityStack.startPausingLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step10-ActivityStack-finishCurrentActivityLocked"><span class="toc-number">1.0.10.</span> <span class="toc-text">Step10.ActivityStack.finishCurrentActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step11-ActivityStack-destroyActivityLocked"><span class="toc-number">1.0.11.</span> <span class="toc-text">Step11.ActivityStack.destroyActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step12-ActivityStack-cleanUpActivityLocked"><span class="toc-number">1.0.12.</span> <span class="toc-text">Step12.ActivityStack.cleanUpActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step13-ActivityManagerService-resetFocusedActivityIfNeededLocked"><span class="toc-number">1.0.13.</span> <span class="toc-text">Step13.ActivityManagerService.resetFocusedActivityIfNeededLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step14-ActivityManagerService-setFocusedActivityLocked"><span class="toc-number">1.0.14.</span> <span class="toc-text">Step14.ActivityManagerService.setFocusedActivityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step15-ActivityStack-cleanUpActivityServicesLocked"><span class="toc-number">1.0.15.</span> <span class="toc-text">Step15.ActivityStack.cleanUpActivityServicesLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step16-ApplicationThreadNative-scheduleDestroyActivity"><span class="toc-number">1.0.16.</span> <span class="toc-text">Step16.ApplicationThreadNative.scheduleDestroyActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step17-ApplicationThread-scheduleDestroyActivity"><span class="toc-number">1.0.17.</span> <span class="toc-text">Step17.ApplicationThread.scheduleDestroyActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step18-ActivityThread-H-handleMessage"><span class="toc-number">1.0.18.</span> <span class="toc-text">Step18.ActivityThread.H.handleMessage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step19-ActivityThread-handleDestroyActivity"><span class="toc-number">1.0.19.</span> <span class="toc-text">Step19.ActivityThread.handleDestroyActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step20-ActivityThread-performDestroyActivity"><span class="toc-number">1.0.20.</span> <span class="toc-text">Step20.ActivityThread.performDestroyActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step21-ActivityThread-performPauseActivityIfNeeded"><span class="toc-number">1.0.21.</span> <span class="toc-text">Step21.ActivityThread.performPauseActivityIfNeeded</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step22-Instrumentation-callActivityOnPause"><span class="toc-number">1.0.22.</span> <span class="toc-text">Step22.Instrumentation.callActivityOnPause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step23-Activity-performPause"><span class="toc-number">1.0.23.</span> <span class="toc-text">Step23.Activity.performPause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step24-Activity-onPause"><span class="toc-number">1.0.24.</span> <span class="toc-text">Step24.Activity.onPause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step25-Activity-performStop"><span class="toc-number">1.0.25.</span> <span class="toc-text">Step25.Activity.performStop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step26-Instrumentation-callActivityOnStop"><span class="toc-number">1.0.26.</span> <span class="toc-text">Step26.Instrumentation.callActivityOnStop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step28-Instrumentation-callActivityOnDestroy"><span class="toc-number">1.0.27.</span> <span class="toc-text">Step28.Instrumentation.callActivityOnDestroy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step29-Activity-performDestroy"><span class="toc-number">1.0.28.</span> <span class="toc-text">Step29.Activity.performDestroy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step31-AMP-activityDestroyed"><span class="toc-number">1.0.29.</span> <span class="toc-text">Step31.AMP.activityDestroyed</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step32-AMS-activityDestroyed"><span class="toc-number">1.0.30.</span> <span class="toc-text">Step32.AMS.activityDestroyed</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step33-ActivityStack-activityDestroyedLocked"><span class="toc-number">1.0.31.</span> <span class="toc-text">Step33.ActivityStack.activityDestroyedLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step35-ActivityStack-removeActivityFromHistoryLocked"><span class="toc-number">1.0.32.</span> <span class="toc-text">Step35.ActivityStack.removeActivityFromHistoryLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step39-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><span class="toc-number">1.0.33.</span> <span class="toc-text">Step39.ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">流程图：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%9C%B0%E5%9D%80%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">代码地址：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8"><span class="toc-number">4.</span> <span class="toc-text">注</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/11/ANR07/" title="ANR-实例分析-启动应用被杀">ANR-实例分析-启动应用被杀</a><time datetime="2024-11-11T13:57:56.000Z" title="发表于 2024-11-11 21:57:56">2024-11-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/04/ANR06/" title="ANR-实例分析-Input dispatching timed out">ANR-实例分析-Input dispatching timed out</a><time datetime="2024-11-04T14:17:38.000Z" title="发表于 2024-11-04 22:17:38">2024-11-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/ANR05/" title="ANR-实例分析-启动应用失败">ANR-实例分析-启动应用失败</a><time datetime="2024-10-28T14:04:48.000Z" title="发表于 2024-10-28 22:04:48">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/21/ANR04/" title="ANR-分析之基础知识介绍：logcat">ANR-分析之基础知识介绍：logcat</a><time datetime="2024-10-21T14:19:03.000Z" title="发表于 2024-10-21 22:19:03">2024-10-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/25/Google-Jetpack-Compose-Animation/" title="Google-Jetpack-Compose-Animation">Google-Jetpack-Compose-Animation</a><time datetime="2024-08-24T16:54:13.000Z" title="发表于 2024-08-25 00:54:13">2024-08-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2024 By 墨香</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>