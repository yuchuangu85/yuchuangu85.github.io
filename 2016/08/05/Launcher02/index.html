<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>墨香带你学Launcher之（二）- 数据加载流程 | 墨香博客</title><meta name="author" content="墨香"><meta name="copyright" content="墨香"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="上一篇墨香带你学Launcher之（一）- 概述,我已经介绍了Launcher的布局以及相关的界面跳转,今天我们继续学习,按照计划,我们开始学习Launcher启动之数据加载,主要是图标、Widget和文件夹的加载.">
<meta property="og:type" content="article">
<meta property="og:title" content="墨香带你学Launcher之（二）- 数据加载流程">
<meta property="og:url" content="http://www.codemx.cn/2016/08/05/Launcher02/index.html">
<meta property="og:site_name" content="墨香博客">
<meta property="og:description" content="上一篇墨香带你学Launcher之（一）- 概述,我已经介绍了Launcher的布局以及相关的界面跳转,今天我们继续学习,按照计划,我们开始学习Launcher启动之数据加载,主要是图标、Widget和文件夹的加载.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.codemx.cn/img/head.jpg">
<meta property="article:published_time" content="2016-08-05T14:20:08.000Z">
<meta property="article:modified_time" content="2024-07-12T16:41:32.277Z">
<meta property="article:author" content="墨香">
<meta property="article:tag" content="Launcher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.codemx.cn/img/head.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.codemx.cn/2016/08/05/Launcher02/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '墨香带你学Launcher之（二）- 数据加载流程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-13 00:41:32'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bg.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="墨香博客"><span class="site-name">墨香博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">墨香带你学Launcher之（二）- 数据加载流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2016-08-05T14:20:08.000Z" title="发表于 2016-08-05 22:20:08">2016-08-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-12T16:41:32.277Z" title="更新于 2024-07-13 00:41:32">2024-07-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Launcher/">Launcher</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="墨香带你学Launcher之（二）- 数据加载流程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><blockquote>
<p>上一篇<a href="http://www.codemx.cn/2016/07/30/%E5%A2%A8%E9%A6%99%E5%B8%A6%E4%BD%A0%E5%AD%A6Launcher%E4%B9%8B-%E6%A6%82%E8%BF%B0/">墨香带你学Launcher之（一）- 概述</a>,我已经介绍了Launcher的布局以及相关的界面跳转,今天我们继续学习,按照计划,我们开始学习Launcher启动之数据加载,主要是图标、Widget和文件夹的加载.</p>
</blockquote>
<span id="more"></span>

<h3 id="1-基础知识"><a href="#1-基础知识" class="headerlink" title="1.基础知识"></a>1.基础知识</h3><hr>
<p>在介绍加载之前我先介绍一点需要用的相关知识:</p>
<ul>
<li><p>Launcher:继承Activity,是桌面的主界面,因此可知,桌面其实就是一个activity,只是和平常的应用不同,他用来显示图标、Widget和文件夹等;</p>
</li>
<li><p>LauncherModel:继承BroadcastReceiver,由此可知他是一个广播接收器,用来接收广播,另外,LauncherModel还主要加载数据;</p>
</li>
<li><p>LauncherProvider:继承ContentProvider,主要是处理数据库操作;</p>
</li>
<li><p>LauncherAppState:单例模式的全局管理类,主要是初始化一些对象,注册广播等.</p>
</li>
<li><p>Compat:兼容包,带有这个后缀的都是做兼容处理的类.</p>
</li>
</ul>
<h3 id="2-默认图标配置"><a href="#2-默认图标配置" class="headerlink" title="2.默认图标配置"></a>2.默认图标配置</h3><hr>
<p>我们在买回新的手机或者第一次安装新的Launcher后,会发现手机的第一页已经有了一些应用的图标和时钟或者天气插件,那么这个是怎么实现的呢?其实,手机在出厂的时候或者Launcher发到市场的时候已经默认排布了一些应用,在第一启动时就会加载并且判断手机中是否有这些图标,如果有则显示到固定位置,这个位置其实是已经写好的.下面我们看看这个位置到底在哪里写好的.</p>
<p>下面是Launcher的资源文件,我们看这个比我们平时的多一个xml文件夹,里面有很多xml文件,那么这些是做什么用的,我来解释一下,有三个文件,分别为default_workspace_4x4.xml,default_workspace_5x5.xml和default_workspace_5x6.xml,这三个文件就是我们默认的布局文件,后面的跟着的4x4、5x5和5x6表示桌面图标的列数和行数,也就是4行4列,5行5列,5行6列,这个怎么用我们后面再说.</p>
<p><img src="/images/launcher/image02/launcher01.png" alt="01"></p>
<p>我们先看一下default_workspace_4x4.xml这个文件中的代码:</p>
<p><img src="/images/launcher/image02/launcher02.png" alt="02"></p>
<p>第20行是一个include的文件,在xml文件夹中的名字dw_phone_hotseat文件,我们后面在看,接着看上图的下面的代码,下面是三个resolve文件,里面包含一些信息,screen表示第几屏,x表示横向的位置,y表示纵向的位置,那么这个位置怎定的呢,我来画一个4x4的图你就明白了:</p>
<p><img src="/images/launcher/image02/launcher03.png" alt="03"></p>
<p>先看上半部分,就是我们说的4x4部分,每一格表示一个图标,在我们绘制图标的时候已经分好了格,每格的大小,只要知道知道他的位置即可绘制图标到相应的位置,那么代码中的x,y就是这个图标的位置.上面resolve中还有两个favorite,在第一个中最后面有个”APP_”,这个我们一看就知道是应用的属性,其实这就表示我们配置了那个app在这个位置,我们再看一下上面介绍的hotseat那个xml文件:</p>
<p><img src="/images/launcher/image02/launcher04.png" alt="04"></p>
<p>这个图我只截图了一部分,想看全部的可以下载我github上的源码查看,其实只是重复,我介绍一个就知道了,上一章我介绍过hotseat这个概念,其实就是我们手机最下面的那个四个或者五个最常用的app图标,这个就是在这里面配置的,我以第一个为例来介绍这个Hotseat配置,我们先看第21行,这个比我们前面介绍的多个属性就是这个container,之前的是没有的,这个就表示容器,-101就是hotseat,也就是这个图标放置到Hotseat中,Hotseat只有一行,所以只有x在变,而y不变.</p>
<p>到此基本的桌面默认图标显示配置就介绍完了,如果你需要默认显示哪个只需要配置这个文件即可.</p>
<h3 id="3-Launcher启动过程"><a href="#3-Launcher启动过程" class="headerlink" title="3.Launcher启动过程"></a>3.Launcher启动过程</h3><hr>
<p>下面我们开始介绍Launcher的启动过程.分析Launcher的启动过程要从源码开始分析.在源码中是通过startHomeActivityLocked这个方法调用的启动Launcher,我们先看一下哪里开始调用的这个函数,</p>
<p><img src="/images/launcher/image02/launcher05.png" alt="05"></p>
<p>从上面的调用图可知有三个地方调用了启动Launcher的方法,这三个方法中首次启动应该是中间的那个systemReady方法,系统准备过程中调用启动Launcher,我们看一下systemReady方法是哪里调用的来验证一下:</p>
<p><img src="/images/launcher/image02/launcher06.png" alt="06"></p>
<p>从上代码静态分析图来看最开始是在System.main方法开始的,正好这个方法就是启动系统的一个入口,也就是在这个过程中启动了Launcher,找到调用的地方后,我们来看一下startHomeActivityLocked是怎么启动Launcher的,首先看一下源码:</p>
<p><img src="/images/launcher/image02/launcher07.png" alt="07"></p>
<p>我们看上面的3437行,获取Intent,再看3451行,如果不为空,则启动HomeActivity,我们看一下这个Intent是什么的Intent:</p>
<p><img src="/images/launcher/image02/launcher08.png" alt="08"></p>
<p>上面的3424行,有个Intent.CATEGORY_HOME,我们在Intent中找到这个属性的代码:</p>
<p><img src="/images/launcher/image02/launcher09.png" alt="09"></p>
<p>这个就是我们上一章讲的设置app为launcher的属性值.</p>
<p>通过上面这些分析可以看到系统是怎么启动launcher的.下面我们看是介绍Launcher内部是如何启动的.</p>
<h3 id="4-Launcher初始化"><a href="#4-Launcher初始化" class="headerlink" title="4.Launcher初始化"></a>4.Launcher初始化</h3><hr>
<p>我们知道App的启动是从Application开始的,但是我们最新的Launcher3中,谷歌工程师把这个类移除,再次之前的版本都是有这个类的,我在这提一下就是因为开发以前launcher的时候遇到一个问题,就是在Application和ContentProvider同时存在时,ContentProvider的onCreate方法要比Application的onCreate方法先启动,下面我们通过源码分析来验证这个问题.</p>
<p>启动Application是从ActivityManagerService中的attachApplication方法开始的,代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">attachApplication</span><span class="params">(IApplicationThread thread)</span> &#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">           <span class="type">int</span> <span class="variable">callingPid</span> <span class="operator">=</span> Binder.getCallingPid();</span><br><span class="line">           <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">           attachApplicationLocked(thread, callingPid);</span><br><span class="line">           Binder.restoreCallingIdentity(origId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接着调用attachApplicationLocked方法,代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">attachApplicationLocked</span><span class="params">(IApplicationThread thread, <span class="type">int</span> pid)</span> &#123;</span><br><span class="line">     app.makeActive(thread, mProcessStats);</span><br><span class="line">     app.curAdj = app.setAdj = -<span class="number">100</span>;</span><br><span class="line">     app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</span><br><span class="line">     app.forcingToForeground = <span class="literal">null</span>;</span><br><span class="line">     updateProcessForegroundLocked(app, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">     app.hasShownUi = <span class="literal">false</span>;</span><br><span class="line">     app.debugging = <span class="literal">false</span>;</span><br><span class="line">     app.cached = <span class="literal">false</span>;</span><br><span class="line">     app.killedByAm = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">     mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line"></span><br><span class="line">     <span class="type">boolean</span> <span class="variable">normalMode</span> <span class="operator">=</span> mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line">     List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!normalMode) &#123;</span><br><span class="line">         Slog.i(TAG, <span class="string">&quot;Launching preboot mode app: &quot;</span> + app);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">         TAG, <span class="string">&quot;New app record &quot;</span> + app</span><br><span class="line">         + <span class="string">&quot; thread=&quot;</span> + thread.asBinder() + <span class="string">&quot; pid=&quot;</span> + pid);</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">         <span class="type">ProfilerInfo</span> <span class="variable">profilerInfo</span> <span class="operator">=</span> profileFile == <span class="literal">null</span> ? <span class="literal">null</span></span><br><span class="line">                 : <span class="keyword">new</span> <span class="title class_">ProfilerInfo</span>(profileFile, profileFd, samplingInterval, profileAutoStop);</span><br><span class="line">         thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">                 profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                 app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</span><br><span class="line">                 isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                 <span class="keyword">new</span> <span class="title class_">Configuration</span>(mConfiguration), app.compat,</span><br><span class="line">                 getCommonServicesLocked(app.isolated),</span><br><span class="line">                 mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">         updateLruProcessLocked(app, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">         app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">         app.resetPackageList(mProcessStats);</span><br><span class="line">         app.unlinkDeathRecipient();</span><br><span class="line">         startProcessLocked(app, <span class="string">&quot;bind fail&quot;</span>, processName);</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面代码中主要有一个thread.bindApplication方法来绑定application,接着看bindApplication代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span></span><br><span class="line"><span class="params">               List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span></span><br><span class="line"><span class="params">               ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span></span><br><span class="line"><span class="params">               IInstrumentationWatcher instrumentationWatcher,</span></span><br><span class="line"><span class="params">               IUiAutomationConnection instrumentationUiConnection, <span class="type">int</span> debugMode,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span> enableOpenGlTrace, <span class="type">boolean</span> isRestrictedBackupMode, <span class="type">boolean</span> persistent,</span></span><br><span class="line"><span class="params">               Configuration config, CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services,</span></span><br><span class="line"><span class="params">               Bundle coreSettings)</span> &#123;</span><br><span class="line"></span><br><span class="line">           ...</span><br><span class="line"></span><br><span class="line">           <span class="type">AppBindData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppBindData</span>();</span><br><span class="line">           data.processName = processName;</span><br><span class="line">           data.appInfo = appInfo;</span><br><span class="line">           data.providers = providers;</span><br><span class="line">           data.instrumentationName = instrumentationName;</span><br><span class="line">           data.instrumentationArgs = instrumentationArgs;</span><br><span class="line">           data.instrumentationWatcher = instrumentationWatcher;</span><br><span class="line">           data.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br><span class="line">           data.debugMode = debugMode;</span><br><span class="line">           data.enableOpenGlTrace = enableOpenGlTrace;</span><br><span class="line">           data.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">           data.persistent = persistent;</span><br><span class="line">           data.config = config;</span><br><span class="line">           data.compatInfo = compatInfo;</span><br><span class="line">           data.initProfilerInfo = profilerInfo;</span><br><span class="line">           sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>准备data数据，然后发送消息到Handler，Handler中处理消息的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">&quot;&gt;&gt;&gt; handling: &quot;</span> + codeToString(msg.what));</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> BIND_APPLICATION:</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;bindApplication&quot;</span>);</span><br><span class="line">                    <span class="type">AppBindData</span> <span class="variable">data</span> <span class="operator">=</span> (AppBindData)msg.obj;</span><br><span class="line">                    handleBindApplication(data);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">&quot;&lt;&lt;&lt; done: &quot;</span> + codeToString(msg.what));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据消息类型BIND_APPLICATION来判断调用handleBindApplication方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleBindApplication</span><span class="params">(AppBindData data)</span> &#123;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">           <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">           <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> data.info.makeApplication(data.restrictedBackupMode, <span class="literal">null</span>);</span><br><span class="line">           mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// don&#x27;t bring up providers in restricted mode; they may depend on the</span></span><br><span class="line">           <span class="comment">// app&#x27;s custom Application class</span></span><br><span class="line">           <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">               List&lt;ProviderInfo&gt; providers = data.providers;</span><br><span class="line">               <span class="keyword">if</span> (providers != <span class="literal">null</span>) &#123;</span><br><span class="line">               </span><br><span class="line">               	<span class="comment">//安装ContentProviders</span></span><br><span class="line">                   installContentProviders(app, providers);</span><br><span class="line">                   </span><br><span class="line">                   <span class="comment">// For process that contains content providers, we want to</span></span><br><span class="line">                   <span class="comment">// ensure that the JIT is enabled &quot;at some point&quot;.</span></span><br><span class="line">                   mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">      		...</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//启动Application的onCreate方法</span></span><br><span class="line">               mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                       <span class="string">&quot;Unable to create application &quot;</span> + app.getClass().getName()</span><br><span class="line">                       + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面函数中调用installContentProviders方法来安装ContentProvider，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installContentProviders</span><span class="params">(</span></span><br><span class="line"><span class="params">           Context context, List&lt;ProviderInfo&gt; providers)</span> &#123;</span><br><span class="line">       <span class="keyword">final</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt; results =</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;IActivityManager.ContentProviderHolder&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (ProviderInfo cpi : providers) &#123;</span><br><span class="line">           <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">               <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">128</span>);</span><br><span class="line">               buf.append(<span class="string">&quot;Pub &quot;</span>);</span><br><span class="line">               buf.append(cpi.authority);</span><br><span class="line">               buf.append(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">               buf.append(cpi.name);</span><br><span class="line">               Log.i(TAG, buf.toString());</span><br><span class="line">           &#125;</span><br><span class="line">           IActivityManager.<span class="type">ContentProviderHolder</span> <span class="variable">cph</span> <span class="operator">=</span> installProvider(context, <span class="literal">null</span>, cpi,</span><br><span class="line">          </span><br><span class="line">           ...</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">     ...</span><br><span class="line">     </span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调用installProvider返回一个IActivityManager.ContentProviderHolder对象，我们看这个方法里面做了哪些处理，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IActivityManager.ContentProviderHolder <span class="title function_">installProvider</span><span class="params">(Context context,</span></span><br><span class="line"><span class="params">            IActivityManager.ContentProviderHolder holder, ProviderInfo info,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> noisy, <span class="type">boolean</span> noReleaseNeeded, <span class="type">boolean</span> stable)</span> &#123;</span><br><span class="line">        <span class="type">ContentProvider</span> <span class="variable">localProvider</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        IContentProvider provider;         <span class="keyword">if</span> (holder == <span class="literal">null</span> || holder.provider == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER || noisy) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">&quot;Loading provider &quot;</span> + info.authority + <span class="string">&quot;: &quot;</span></span><br><span class="line">                        + info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">ApplicationInfo</span> <span class="variable">ai</span> <span class="operator">=</span> info.applicationInfo;</span><br><span class="line">            <span class="keyword">if</span> (context.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">                c = context;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInitialApplication != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                    mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">                c = mInitialApplication;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c = context.createPackageContext(ai.packageName,</span><br><span class="line">                            Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Unable to get context for package &quot;</span> +</span><br><span class="line">                      ai.packageName +</span><br><span class="line">                      <span class="string">&quot; while loading content provider &quot;</span> +</span><br><span class="line">                      info.name);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> c.getClassLoader();</span><br><span class="line">                localProvider = (ContentProvider)cl.</span><br><span class="line">                    loadClass(info.name).newInstance();</span><br><span class="line">                <span class="comment">//获取ContentProvider</span></span><br><span class="line">                provider = localProvider.getIContentProvider();</span><br><span class="line">                <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Failed to instantiate class &quot;</span> +</span><br><span class="line">                          info.name + <span class="string">&quot; from sourceDir &quot;</span> +</span><br><span class="line">                          info.applicationInfo.sourceDir);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(</span><br><span class="line">                    TAG, <span class="string">&quot;Instantiating local provider &quot;</span> + info.name);</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// XXX Need to create the correct context for this provider.</span></span><br><span class="line">                localProvider.attachInfo(c, info);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(<span class="literal">null</span>, e)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                            <span class="string">&quot;Unable to get provider &quot;</span> + info.name</span><br><span class="line">                            + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            provider = holder.provider;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(TAG, <span class="string">&quot;Installing external provider &quot;</span> + info.authority + <span class="string">&quot;: &quot;</span></span><br><span class="line">                    + info.name);</span><br><span class="line">        &#125;    </span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retHolder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面代码中有个关键方法：localProvider.attachInfo(c, info)，这个方法就是添加Provider的，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">attachInfo</span><span class="params">(Context context, ProviderInfo info, <span class="type">boolean</span> testing)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Only allow it to be set once, so after the content service gives</span></span><br><span class="line"><span class="comment">         * this to us clients can&#x27;t change it.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mContext == <span class="literal">null</span>) &#123;</span><br><span class="line">            mContext = context;</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">                mTransport.mAppOpsManager = (AppOpsManager) context.getSystemService(</span><br><span class="line">                        Context.APP_OPS_SERVICE);</span><br><span class="line">            &#125;</span><br><span class="line">            mMyUid = Process.myUid();</span><br><span class="line">            <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">                setReadPermission(info.readPermission);</span><br><span class="line">                setWritePermission(info.writePermission);</span><br><span class="line">                setPathPermissions(info.pathPermissions);</span><br><span class="line">                mExported = info.exported;</span><br><span class="line">            &#125;</span><br><span class="line">            ContentProvider.<span class="built_in">this</span>.onCreate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们看到在最后调用了ContentProvider.this.onCreate()这个方法，然后会返回到handleBindApplication方法中执行mInstrumentation.callApplicationOnCreate(app)方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callApplicationOnCreate</span><span class="params">(Application app)</span> &#123;</span><br><span class="line">     app.onCreate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此我们看到ContentProvider的onCreate方法比Application的onCreate方法调用早。这里只是简单介绍详细过程去看源码。</p>
<p>我现在讲解的是基于最新的Launcher3代码，因此我们这个Launcher中没有Application，所以程序启动最开始的是ContentProvider的onCreate方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line">        StrictMode.<span class="type">ThreadPolicy</span> <span class="variable">oldPolicy</span> <span class="operator">=</span> StrictMode.allowThreadDiskWrites();</span><br><span class="line">        mOpenHelper = <span class="keyword">new</span> <span class="title class_">DatabaseHelper</span>(context);</span><br><span class="line">        StrictMode.setThreadPolicy(oldPolicy);</span><br><span class="line">        LauncherAppState.setLauncherProvider(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码中处理的事情不多，主要是启动严苛模式和创建数据库，关于严苛模式的具体信息看官方文档或者博客，都有很详细的讲解，然后将ContentProvider放置到整个Launcher的管理类LauncherAppState中，以方便获取。</p>
<p>接下来就是启动Launcher,我么看一下Launcher中的onCreate方法中的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STRICT_MODE) &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(<span class="keyword">new</span> <span class="title class_">StrictMode</span>.ThreadPolicy.Builder()</span><br><span class="line">                    .detectDiskReads()</span><br><span class="line">                    .detectDiskWrites()</span><br><span class="line">                    .detectNetwork()   <span class="comment">// or .detectAll() for all detectable problems</span></span><br><span class="line">                    .penaltyLog()</span><br><span class="line">                    .build());</span><br><span class="line">            StrictMode.setVmPolicy(<span class="keyword">new</span> <span class="title class_">StrictMode</span>.VmPolicy.Builder()</span><br><span class="line">                    .detectLeakedSqlLiteObjects()</span><br><span class="line">                    .detectLeakedClosableObjects()</span><br><span class="line">                    .penaltyLog()</span><br><span class="line">                    .penaltyDeath()</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLauncherCallbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">            mLauncherCallbacks.preOnCreate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        LauncherAppState.setApplicationContext(getApplicationContext());</span><br><span class="line">        <span class="type">LauncherAppState</span> <span class="variable">app</span> <span class="operator">=</span> LauncherAppState.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load configuration-specific DeviceProfile</span></span><br><span class="line">        mDeviceProfile = getResources().getConfiguration().orientation</span><br><span class="line">                == Configuration.ORIENTATION_LANDSCAPE ?</span><br><span class="line">                app.getInvariantDeviceProfile().landscapeProfile</span><br><span class="line">                : app.getInvariantDeviceProfile().portraitProfile;</span><br><span class="line"></span><br><span class="line">        mSharedPrefs = getSharedPreferences(LauncherAppState.getSharedPreferencesKey(),</span><br><span class="line">                Context.MODE_PRIVATE);</span><br><span class="line">        mIsSafeModeEnabled = getPackageManager().isSafeMode();</span><br><span class="line">        mModel = app.setLauncher(<span class="built_in">this</span>);</span><br><span class="line">        mIconCache = app.getIconCache();</span><br><span class="line"></span><br><span class="line">        mDragController = <span class="keyword">new</span> <span class="title class_">DragController</span>(<span class="built_in">this</span>);</span><br><span class="line">        mInflater = getLayoutInflater();</span><br><span class="line">        mStateTransitionAnimation = <span class="keyword">new</span> <span class="title class_">LauncherStateTransitionAnimation</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        mStats = <span class="keyword">new</span> <span class="title class_">Stats</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        mAppWidgetManager = AppWidgetManagerCompat.getInstance(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        mAppWidgetHost = <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetHost</span>(<span class="built_in">this</span>, APPWIDGET_HOST_ID);</span><br><span class="line">        mAppWidgetHost.startListening();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we are getting an onCreate, we can actually preempt onResume and unset mPaused here,</span></span><br><span class="line">        <span class="comment">// this also ensures that any synchronous binding below doesn&#x27;t re-trigger another</span></span><br><span class="line">        <span class="comment">// LauncherModel load.</span></span><br><span class="line">        mPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PROFILE_STARTUP) &#123;</span><br><span class="line">            android.os.Debug.startMethodTracing(</span><br><span class="line">                    Environment.getExternalStorageDirectory() + <span class="string">&quot;/launcher&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.launcher);</span><br><span class="line"></span><br><span class="line">        registerHomeKey();</span><br><span class="line">        setupViews();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//动态设置各布局的参数</span></span><br><span class="line">        mDeviceProfile.layout(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        mSavedState = savedInstanceState;</span><br><span class="line">        restoreState(mSavedState);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PROFILE_STARTUP) &#123;</span><br><span class="line">            android.os.Debug.stopMethodTracing();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mRestoring) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DISABLE_SYNCHRONOUS_BINDING_CURRENT_PAGE) &#123;</span><br><span class="line">                <span class="comment">// If the user leaves launcher, then we should just load items asynchronously when</span></span><br><span class="line">                <span class="comment">// they return.</span></span><br><span class="line">                mModel.startLoader(PagedView.INVALID_RESTORE_PAGE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// We only load the page synchronously if the user rotates (or triggers a</span></span><br><span class="line">                <span class="comment">// configuration change) while launcher is in the foreground</span></span><br><span class="line">                mModel.startLoader(mWorkspace.getRestorePage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For handling default keys</span></span><br><span class="line">        mDefaultKeySsb = <span class="keyword">new</span> <span class="title class_">SpannableStringBuilder</span>();</span><br><span class="line">        Selection.setSelection(mDefaultKeySsb, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(Intent.ACTION_CLOSE_SYSTEM_DIALOGS);</span><br><span class="line">        registerReceiver(mCloseSystemDialogsReceiver, filter);</span><br><span class="line"></span><br><span class="line">        mRotationEnabled = Utilities.isRotationAllowedForDevice(getApplicationContext());</span><br><span class="line">        <span class="comment">// In case we are on a device with locked rotation, we should look at preferences to check</span></span><br><span class="line">        <span class="comment">// if the user has specifically allowed rotation.</span></span><br><span class="line">        <span class="keyword">if</span> (!mRotationEnabled) &#123;</span><br><span class="line">            mRotationEnabled = Utilities.isAllowRotationPrefEnabled(getApplicationContext(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// On large interfaces, or on devices that a user has specifically enabled screen rotation,</span></span><br><span class="line">        <span class="comment">// we want the screen to auto-rotate based on the current orientation</span></span><br><span class="line">        setOrientation();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLauncherCallbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">            mLauncherCallbacks.onCreate(savedInstanceState);</span><br><span class="line">            <span class="keyword">if</span> (mLauncherCallbacks.hasLauncherOverlay()) &#123;</span><br><span class="line">                <span class="type">ViewStub</span> <span class="variable">stub</span> <span class="operator">=</span> (ViewStub) findViewById(R.id.launcher_overlay_stub);</span><br><span class="line">                mLauncherOverlayContainer = (InsettableFrameLayout) stub.inflate();</span><br><span class="line">                mLauncherOverlay = mLauncherCallbacks.setLauncherOverlayView(</span><br><span class="line">                        mLauncherOverlayContainer, mLauncherOverlayCallbacks);</span><br><span class="line">                mWorkspace.setLauncherOverlay(mLauncherOverlay);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldShowIntroScreen()) &#123;</span><br><span class="line">            showIntroScreen();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            showFirstRunActivity();</span><br><span class="line">            showFirstRunClings();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码比较多我们看一下执行过程图：</p>
<p><img src="/images/launcher/image02/launcher11.png" alt="11"></p>
<p>首先是启动严苛模式，准备回调接口，初始化LauncherAppState：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="title function_">LauncherAppState</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (sContext == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;LauncherAppState inited before app context set&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (sContext.getResources().getBoolean(R.bool.debug_memory_enabled)) &#123;</span><br><span class="line">          MemoryTracker.startTrackingMe(sContext, <span class="string">&quot;L&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化固定的设备配置</span></span><br><span class="line">      mInvariantDeviceProfile = <span class="keyword">new</span> <span class="title class_">InvariantDeviceProfile</span>(sContext);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//初始化图标管理工具</span></span><br><span class="line">      mIconCache = <span class="keyword">new</span> <span class="title class_">IconCache</span>(sContext, mInvariantDeviceProfile);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//初始化Widget加载混存工具</span></span><br><span class="line">      mWidgetCache = <span class="keyword">new</span> <span class="title class_">WidgetPreviewLoader</span>(sContext, mIconCache);</span><br><span class="line"></span><br><span class="line">      mAppFilter = AppFilter.loadByName(sContext.getString(R.string.app_filter_class));</span><br><span class="line">      mBuildInfo = BuildInfo.loadByName(sContext.getString(R.string.build_info_class));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//初始化广播</span></span><br><span class="line">      mModel = <span class="keyword">new</span> <span class="title class_">LauncherModel</span>(<span class="built_in">this</span>, mIconCache, mAppFilter);</span><br><span class="line"></span><br><span class="line">      LauncherAppsCompat.getInstance(sContext).addOnAppsChangedCallback(mModel);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Register intent receivers</span></span><br><span class="line">      <span class="type">IntentFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">      filter.addAction(Intent.ACTION_LOCALE_CHANGED);</span><br><span class="line">      filter.addAction(SearchManager.INTENT_GLOBAL_SEARCH_ACTIVITY_CHANGED);</span><br><span class="line">      <span class="comment">// For handling managed profiles</span></span><br><span class="line">      filter.addAction(LauncherAppsCompat.ACTION_MANAGED_PROFILE_ADDED);</span><br><span class="line">      filter.addAction(LauncherAppsCompat.ACTION_MANAGED_PROFILE_REMOVED);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册广播</span></span><br><span class="line">      sContext.registerReceiver(mModel, filter);</span><br><span class="line">      UserManagerCompat.getInstance(sContext).enableAndResetCache();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后初始化手机固件信息对象DeviceProfile，初始化拖拽管理器DragController，然后初始化小部件管理器，加载布局，初始化桌面各个控件，并且设置各个控件的位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">layout</span><span class="params">(Launcher launcher)</span> &#123;</span><br><span class="line">        FrameLayout.LayoutParams lp;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasVerticalBarLayout</span> <span class="operator">=</span> isVerticalBarLayout();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isLayoutRtl</span> <span class="operator">=</span> Utilities.isRtl(launcher.getResources());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Layout the search bar space</span></span><br><span class="line">        <span class="type">View</span> <span class="variable">searchBar</span> <span class="operator">=</span> launcher.getSearchDropTargetBar();</span><br><span class="line">        lp = (FrameLayout.LayoutParams) searchBar.getLayoutParams();</span><br><span class="line">        <span class="keyword">if</span> (hasVerticalBarLayout) &#123;</span><br><span class="line">            <span class="comment">// Vertical search bar space -- The search bar is fixed in the layout to be on the left</span></span><br><span class="line">            <span class="comment">//                              of the screen regardless of RTL</span></span><br><span class="line">            lp.gravity = Gravity.LEFT;</span><br><span class="line">            lp.width = searchBarSpaceHeightPx;</span><br><span class="line"></span><br><span class="line">            <span class="type">LinearLayout</span> <span class="variable">targets</span> <span class="operator">=</span> (LinearLayout) searchBar.findViewById(R.id.drag_target_bar);</span><br><span class="line">            targets.setOrientation(LinearLayout.VERTICAL);</span><br><span class="line">            FrameLayout.<span class="type">LayoutParams</span> <span class="variable">targetsLp</span> <span class="operator">=</span> (FrameLayout.LayoutParams) targets.getLayoutParams();</span><br><span class="line">            targetsLp.gravity = Gravity.TOP;</span><br><span class="line">            targetsLp.height = LayoutParams.WRAP_CONTENT;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Horizontal search bar space</span></span><br><span class="line">            lp.gravity = Gravity.TOP;</span><br><span class="line">            lp.height = searchBarSpaceHeightPx;</span><br><span class="line"></span><br><span class="line">            <span class="type">LinearLayout</span> <span class="variable">targets</span> <span class="operator">=</span> (LinearLayout) searchBar.findViewById(R.id.drag_target_bar);</span><br><span class="line">            targets.getLayoutParams().width = searchBarSpaceWidthPx;</span><br><span class="line">        &#125;</span><br><span class="line">        searchBar.setLayoutParams(lp);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//其他省略</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里就是动态设置桌面各个控件的位置及宽高等属性。当所有信息初始化完成后，就开始调用mModel.startLoader方法来加载应用数据。下面我们详细来讲数据加载流程。</p>
<h3 id="5-Launcher数据加载"><a href="#5-Launcher数据加载" class="headerlink" title="5.Launcher数据加载"></a>5.Launcher数据加载</h3><hr>
<p>数据加载主要是从LauncherModel中的startLoader方法开始，先看一下这个方法做的事情：</p>
<p><img src="/images/launcher/image02/launcher12.png" alt="12"></p>
<p>这里的事情不多，主要是调用LoaderTask这个任务，LoaderTask实现了Runnable这个接口，因此首先执行润run方法，我么看一下这个run方法里面做了哪些事情，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">           </span><br><span class="line">           ...</span><br><span class="line">           </span><br><span class="line">           keep_running:</span><br><span class="line">           &#123;</span><br><span class="line">               </span><br><span class="line">               loadAndBindWorkspace();</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">                   <span class="keyword">break</span> keep_running;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               waitForIdle();</span><br><span class="line"></span><br><span class="line">               ...</span><br><span class="line">               </span><br><span class="line">               loadAndBindAllApps();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">         ...</span><br><span class="line">         </span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个方法中主要是三件事，我们用时序图表一下：</p>
<p><img src="/images/launcher/image02/launcher13.png" alt="13"></p>
<p>首先是执行loadAndBindWorkspace方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadAndBindWorkspace</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">           ...</span><br><span class="line">           </span><br><span class="line">           <span class="comment">//判断workspace是否已经加载</span></span><br><span class="line">           <span class="keyword">if</span> (!mWorkspaceLoaded) &#123;</span><br><span class="line">               loadWorkspace();</span><br><span class="line">               <span class="keyword">synchronized</span> (LoaderTask.<span class="built_in">this</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   mWorkspaceLoaded = <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Bind the workspace</span></span><br><span class="line">           bindWorkspace(-<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里面主要是执行loadWorkspace和bindWorkspace，也就是加载workspace的应用并且进行绑定。先看loadWorkspace方法，代码很多，我们只贴关键部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadWorkspace</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//初始化一些值</span></span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((mFlags &amp; LOADER_FLAG_MIGRATE_SHORTCUTS) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// append the user&#x27;s Launcher2 shortcuts</span></span><br><span class="line">                Launcher.addDumpLog(TAG, <span class="string">&quot;loadWorkspace: migrating from launcher2&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                LauncherAppState.getLauncherProvider().migrateLauncher2Shortcuts();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Make sure the default workspace is loaded</span></span><br><span class="line">                Launcher.addDumpLog(TAG, <span class="string">&quot;loadWorkspace: loading default favorites&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">                LauncherAppState.getLauncherProvider().loadDefaultFavoritesIfNecessary();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (sBgLock) &#123;</span><br><span class="line">            	<span class="comment">//初始化一些值</span></span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//从数据库查询解析出来的所有应用信息</span></span><br><span class="line">                   ...</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (!mStopped &amp;&amp; c.moveToNext()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">itemType</span> <span class="operator">=</span> c.getInt(itemTypeIndex);</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">restored</span> <span class="operator">=</span> <span class="number">0</span> != c.getInt(restoredIndex);</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">allowMissingTarget</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                            container = c.getInt(containerIndex);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">switch</span> (itemType) &#123;</span><br><span class="line">                                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:</span><br><span class="line">                                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:</span><br><span class="line">                                </span><br><span class="line">                                    ...</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="keyword">try</span> &#123;</span><br><span class="line">                                        intent = Intent.parseUri(intentDescription, <span class="number">0</span>);</span><br><span class="line">                                        <span class="type">ComponentName</span> <span class="variable">cn</span> <span class="operator">=</span> intent.getComponent();</span><br><span class="line">                                        <span class="keyword">if</span> (cn != <span class="literal">null</span> &amp;&amp; cn.getPackageName() != <span class="literal">null</span>) &#123;</span><br><span class="line">                                            <span class="comment">//检测数据库(从xml文件解析出来存入数据库的)中取出来的app包是否存在</span></span><br><span class="line">                                            <span class="type">boolean</span> <span class="variable">validPkg</span> <span class="operator">=</span> launcherApps.isPackageEnabledForProfile(</span><br><span class="line">                                                    cn.getPackageName(), user);</span><br><span class="line">                                            <span class="comment">//检测数据库(从xml文件解析出来存入数据库的)中取出来的app组件是否存在</span></span><br><span class="line">                                            <span class="type">boolean</span> <span class="variable">validComponent</span> <span class="operator">=</span> validPkg &amp;&amp;</span><br><span class="line">                                                    launcherApps.isActivityEnabledForProfile(cn, user);</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">if</span> (validComponent) &#123;</span><br><span class="line">                                            </span><br><span class="line">                                                ...</span><br><span class="line">                                                </span><br><span class="line">                                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validPkg) &#123;</span><br><span class="line">                                               </span><br><span class="line">                                               ...</span><br><span class="line">                                               </span><br><span class="line">                                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (restored) &#123;</span><br><span class="line">                                                </span><br><span class="line">                                                ...</span><br><span class="line">                                                </span><br><span class="line">                                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (launcherApps.isAppEnabled(</span><br><span class="line">                                                    manager, cn.getPackageName(),</span><br><span class="line">                                                    PackageManager.GET_UNINSTALLED_PACKAGES)) &#123;</span><br><span class="line">                                               </span><br><span class="line">                                               ...</span><br><span class="line">                                               </span><br><span class="line">                                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isSdCardReady) &#123;</span><br><span class="line">                                                </span><br><span class="line">                                                ...</span><br><span class="line"></span><br><span class="line">                                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                                </span><br><span class="line">                                                ...</span><br><span class="line">                                                </span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn == <span class="literal">null</span>) &#123;</span><br><span class="line">                                            <span class="comment">// For shortcuts with no component, keep them as they are</span></span><br><span class="line">                                            restoredRows.add(id);</span><br><span class="line">                                            restored = <span class="literal">false</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                                        Launcher.addDumpLog(TAG,</span><br><span class="line">                                                <span class="string">&quot;Invalid uri: &quot;</span> + intentDescription, <span class="literal">true</span>);</span><br><span class="line">                                        itemsToRemove.add(id);</span><br><span class="line">                                        <span class="keyword">continue</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                    ...</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">                                        info.id = id;</span><br><span class="line">                                        info.intent = intent;</span><br><span class="line">                                        info.container = container;</span><br><span class="line">                                        info.screenId = c.getInt(screenIndex);</span><br><span class="line">                                        info.cellX = c.getInt(cellXIndex);</span><br><span class="line">                                        info.cellY = c.getInt(cellYIndex);</span><br><span class="line">                                        info.rank = c.getInt(rankIndex);</span><br><span class="line">                                        info.spanX = <span class="number">1</span>;</span><br><span class="line">                                        info.spanY = <span class="number">1</span>;</span><br><span class="line">                                        info.intent.putExtra(ItemInfo.EXTRA_PROFILE, serialNumber);</span><br><span class="line">                                        ...</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">switch</span> (container) &#123;</span><br><span class="line">                                            <span class="keyword">case</span> LauncherSettings.Favorites.CONTAINER_DESKTOP:</span><br><span class="line">                                            <span class="keyword">case</span> LauncherSettings.Favorites.CONTAINER_HOTSEAT:</span><br><span class="line">                                                sBgWorkspaceItems.add(info);</span><br><span class="line">                                                <span class="keyword">break</span>;</span><br><span class="line">                                            <span class="keyword">default</span>:</span><br><span class="line">                                                <span class="comment">// Item is in a user folder</span></span><br><span class="line">                                                <span class="type">FolderInfo</span> <span class="variable">folderInfo</span> <span class="operator">=</span></span><br><span class="line">                                                        findOrMakeFolder(sBgFolders, container);</span><br><span class="line">                                                folderInfo.add(info);</span><br><span class="line">                                                <span class="keyword">break</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        sBgItemsIdMap.put(info.id, info);</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unexpected null ShortcutInfo&quot;</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_FOLDER:</span><br><span class="line">                                </span><br><span class="line">                                    ...</span><br><span class="line">                                </span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:</span><br><span class="line">                                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET:</span><br><span class="line">                                </span><br><span class="line">                                    ...</span><br><span class="line">                                                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            Launcher.addDumpLog(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Sort all the folder items and make sure the first 3 items are high resolution.</span></span><br><span class="line">                <span class="keyword">for</span> (FolderInfo folder : sBgFolders) &#123;</span><br><span class="line">                    Collections.sort(folder.contents, Folder.ITEM_POS_COMPARATOR);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span> (ShortcutInfo info : folder.contents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (info.usingLowResIcon) &#123;</span><br><span class="line">                            info.updateIcon(mIconCache, <span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        pos++;</span><br><span class="line">                        <span class="keyword">if</span> (pos &gt;= FolderIcon.NUM_ITEMS_IN_PREVIEW) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (restoredRows.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Update restored items that no longer require special handling</span></span><br><span class="line">                    <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">                    values.put(LauncherSettings.Favorites.RESTORED, <span class="number">0</span>);</span><br><span class="line">                    contentResolver.update(LauncherSettings.Favorites.CONTENT_URI, values,</span><br><span class="line">                            Utilities.createDbSelectionQuery(</span><br><span class="line">                                    LauncherSettings.Favorites._ID, restoredRows), <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!isSdCardReady &amp;&amp; !sPendingPackages.isEmpty()) &#123;</span><br><span class="line">                    context.registerReceiver(<span class="keyword">new</span> <span class="title class_">AppsAvailabilityCheck</span>(),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(StartupReceiver.SYSTEM_READY),</span><br><span class="line">                            <span class="literal">null</span>, sWorker);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Remove any empty screens</span></span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If there are any empty screens remove them, and update.</span></span><br><span class="line">                <span class="keyword">if</span> (unusedScreens.size() != <span class="number">0</span>) &#123;</span><br><span class="line">                    sBgWorkspaceScreens.removeAll(unusedScreens);</span><br><span class="line">                    updateWorkspaceScreenOrder(context, sBgWorkspaceScreens);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">               ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先是调用loadDefaultFavoritesIfNecessary这个方法，来解析我们上面讲的配置默认的桌面图标的xml文件，流程就是：初始化AutoInstallsLayout，然后调用LauncherProvider中的loadFavorites方法，在这个方法中调用AutoInstallsLayout中的loadLayout方法来解析配置的xml文件，在AutoInstallsLayout中通过对小部件，图标，文件夹等分类进行分辨解析，解析过程中如果有include标签，则对相应的xml文件进行解析，解析过程相对简单，不在做详细讲解，解析过程中将解析的各种信息存储到数据库中，以方便后面使用，当xml文件解析完成后，开始读取解析xml配置文件存储到数据库的数据，读取出来后，根据相应的类型（图标，小部件，文件夹等）进行判断，判断系统中这个应用是否存在，是否可用，如果可用则生成相应对象并存储到想定的map中，如果不存在则删除数据库中的数据，这样整个判断完成后数据库中的数据就只剩下系统中存在的配置应用过了。</p>
<p>加载完配置应用图标后，开始执行bindWorkspace方法绑定应用图标到桌面，代码略过，我们看一下UML图：</p>
<p><img src="/images/launcher/image02/launcher14.png" alt="14"></p>
<p>通过上面的时序图，我们看到，首先执行过滤工作，比如这个图标是在workspace中还是在Hotseat中，不同的位置放置不同的分类，然后进行排序处理，然后执行bindWorkspaceScreens方法来绑定手机有几个屏幕，接着调用bindWorkspaceItems方法绑定当前屏幕的图标、文件夹和小插件信息，最后调用绑定其他屏幕的应用图标、文件夹和小插件，关于绑定我们下一章再讲。</p>
<p>接着执行LoadTask中的waitForIdle方法，改方法主要是等待加载数据结束。</p>
<p>最后执行loadAndBindAllApps方法来加载第二层的多有图标信息，看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadAndBindAllApps</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (DEBUG_LOADERS) &#123;</span><br><span class="line">               Log.d(TAG, <span class="string">&quot;loadAndBindAllApps mAllAppsLoaded=&quot;</span> + mAllAppsLoaded);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (!mAllAppsLoaded) &#123;</span><br><span class="line">               loadAllApps();</span><br><span class="line">               <span class="keyword">synchronized</span> (LoaderTask.<span class="built_in">this</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               updateIconCache();</span><br><span class="line">               <span class="keyword">synchronized</span> (LoaderTask.<span class="built_in">this</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   mAllAppsLoaded = <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               onlyBindAllApps();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要是如果已经加载了所有应用这只是执行绑定应用，如果没有加载则执行加载操作。下面看加载操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadAllApps</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> List&lt;UserHandleCompat&gt; profiles = mUserManager.getUserProfiles();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Clear the list of apps</span></span><br><span class="line">            mBgAllAppsList.clear();</span><br><span class="line">            <span class="keyword">for</span> (UserHandleCompat user : profiles) &#123;</span><br><span class="line">            </span><br><span class="line">            	...</span><br><span class="line">            </span><br><span class="line">               <span class="keyword">final</span> List&lt;LauncherActivityInfoCompat&gt; apps = mLauncherApps.getActivityList(<span class="literal">null</span>, user);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Fail if we don&#x27;t have any apps</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Fix this. Only fail for the current user.</span></span><br><span class="line">                <span class="keyword">if</span> (apps == <span class="literal">null</span> || apps.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Create the ApplicationInfos</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; apps.size(); i++) &#123;</span><br><span class="line">                    <span class="type">LauncherActivityInfoCompat</span> <span class="variable">app</span> <span class="operator">=</span> apps.get(i);</span><br><span class="line">                    <span class="comment">// This builds the icon bitmaps.</span></span><br><span class="line">                    mBgAllAppsList.add(<span class="keyword">new</span> <span class="title class_">AppInfo</span>(mContext, app, user, mIconCache));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">			...</span><br><span class="line">			</span><br><span class="line">            <span class="comment">// Huh? Shouldn&#x27;t this be inside the Runnable below?</span></span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;AppInfo&gt; added = mBgAllAppsList.added;</span><br><span class="line">            mBgAllAppsList.added = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;AppInfo&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Post callback on main thread</span></span><br><span class="line">            mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">bindTime</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Callbacks</span> <span class="variable">callbacks</span> <span class="operator">=</span> tryGetCallbacks(oldCallbacks);</span><br><span class="line">                    <span class="keyword">if</span> (callbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">                        callbacks.bindAllApplications(added);</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_LOADERS) &#123;</span><br><span class="line">                            Log.d(TAG, <span class="string">&quot;bound &quot;</span> + added.size() + <span class="string">&quot; apps in &quot;</span></span><br><span class="line">                                    + (SystemClock.uptimeMillis() - bindTime) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;not binding apps: no Launcher activity&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            loadAndBindWidgetsAndShortcuts(tryGetCallbacks(oldCallbacks), <span class="literal">true</span> <span class="comment">/* refresh */</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面代码中通过mLauncherApps.getActivityList方法获取所有应用启动界面的一个对象列表，然后根据LauncherActivityInfoCompat来初始化对应的app对象，这样就可以获取手机中所有的应用列表。获取完成后就执行绑定操作，最后调用loadAndBindWidgetsAndShortcuts方法加载绑定小部件和快捷方式到小部件界面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadAndBindWidgetsAndShortcuts</span><span class="params">(<span class="keyword">final</span> Callbacks callbacks, <span class="keyword">final</span> <span class="type">boolean</span> refresh)</span> &#123;</span><br><span class="line"></span><br><span class="line">        runOnWorkerThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                updateWidgetsModel(refresh);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">WidgetsModel</span> <span class="variable">model</span> <span class="operator">=</span> mBgWidgetsModel.clone();</span><br><span class="line"></span><br><span class="line">                mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="type">Callbacks</span> <span class="variable">cb</span> <span class="operator">=</span> getCallback();</span><br><span class="line">                        <span class="keyword">if</span> (callbacks == cb &amp;&amp; cb != <span class="literal">null</span>) &#123;</span><br><span class="line">                            callbacks.bindAllPackages(model);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// update the Widget entries inside DB on the worker thread.</span></span><br><span class="line">                LauncherAppState.getInstance().getWidgetCache().removeObsoletePreviews(</span><br><span class="line">                        model.getRawList());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个方法中首先调用updateWidgetsModel方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateWidgetsModel</span><span class="params">(<span class="type">boolean</span> refresh)</span> &#123;</span><br><span class="line">       <span class="type">PackageManager</span> <span class="variable">packageManager</span> <span class="operator">=</span> mApp.getContext().getPackageManager();</span><br><span class="line">       <span class="keyword">final</span> ArrayList&lt;Object&gt; widgetsAndShortcuts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">       widgetsAndShortcuts.addAll(getWidgetProviders(mApp.getContext(), refresh));</span><br><span class="line">       <span class="type">Intent</span> <span class="variable">shortcutsIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_CREATE_SHORTCUT);</span><br><span class="line">       widgetsAndShortcuts.addAll(packageManager.queryIntentActivities(shortcutsIntent, <span class="number">0</span>));</span><br><span class="line">       mBgWidgetsModel.setWidgetsAndShortcuts(widgetsAndShortcuts);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面代码中通过调用getWidgetProviders来获取所有小部件，通过shortcutsIntent来获取所有的跨界方式，最后通过mBgWidgetsModel.setWidgetsAndShortcuts方法把小部件和快捷方式放到WidgetsModel对象中，在后期加载中可以从这个里面获取小部件和快捷方式。</p>
<p>到这整个launcher的数据加载基本就完成了，还有很多细节没有讲，xml解析等，这个谷歌工程师设计都是非常好的，有兴趣的可以看看源码。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><hr>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/luoshengyang/article/details/6767736">Android系统默认Home应用程序（Launcher）的启动过程源代码分析</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/luoshengyang/article/details/6963418">Android应用程序组件Content Provider的启动过程源代码分析</a></p>
<h3 id="注"><a href="#注" class="headerlink" title="注"></a>注</h3><hr>
<p>本文的源码是基于Android 6.0系统；</p>
<p>Launcher源码：<a target="_blank" rel="noopener" href="https://github.com/yuchuangu85/Launcher3_mx/tree/launcher3_6.0">https://github.com/yuchuangu85/Launcher3_mx&#x2F;tree&#x2F;launcher3_6.0</a></p>
<p>Android开发群：192508518</p>
<p>微信公众号:Code_MX<br><img src="/images/codemx/qr_code_mx.jpg" alt="qr_code_mx"></p>
<p>本文原创，转载请注明出处。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://www.codemx.cn">墨香</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://www.codemx.cn/2016/08/05/Launcher02/">http://www.codemx.cn/2016/08/05/Launcher02/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.codemx.cn" target="_blank">墨香博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Launcher/">Launcher</a></div><div class="post-share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2016/08/14/Launcher03/" title="墨香带你学Launcher之（三）- 绑定屏幕、图标、文件夹和Widget"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">墨香带你学Launcher之（三）- 绑定屏幕、图标、文件夹和Widget</div></div></a><a class="next-post pull-right" href="/2016/07/30/Launcher01/" title="墨香带你学Launcher之（一）- 概述"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">墨香带你学Launcher之（一）- 概述</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2016/07/30/Launcher01/" title="墨香带你学Launcher之（一）- 概述"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-07-30</div><div class="title">墨香带你学Launcher之（一）- 概述</div></div></a><a href="/2016/08/14/Launcher03/" title="墨香带你学Launcher之（三）- 绑定屏幕、图标、文件夹和Widget"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-08-14</div><div class="title">墨香带你学Launcher之（三）- 绑定屏幕、图标、文件夹和Widget</div></div></a><a href="/2016/08/21/Launcher04/" title="墨香带你学Launcher之（四）- 应用安装、更新、卸载时的数据加载"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-08-21</div><div class="title">墨香带你学Launcher之（四）- 应用安装、更新、卸载时的数据加载</div></div></a><a href="/2016/10/16/Launcher05/" title="墨香带你学Launcher之（五）- Workspace滑动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-10-16</div><div class="title">墨香带你学Launcher之（五）- Workspace滑动</div></div></a><a href="/2016/12/18/Launcher07/" title="墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-12-18</div><div class="title">墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节</div></div></a><a href="/2017/05/19/Launcher08/" title="墨香带你学Launcher之（八）- 加载Icon、设置壁纸"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-05-19</div><div class="title">墨香带你学Launcher之（八）- 加载Icon、设置壁纸</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">墨香</div><div class="author-info-description">因为兴趣所以选择，因为选择所以坚持。</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yuchuangu85"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/yuchuangu85" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yuchuangu85@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">路虽远，行则将至；事虽难，做则可成。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">1.基础知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%BB%98%E8%AE%A4%E5%9B%BE%E6%A0%87%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">2.默认图标配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Launcher%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">3.Launcher启动过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Launcher%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">4.Launcher初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Launcher%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">5.</span> <span class="toc-text">5.Launcher数据加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8"><span class="toc-number">7.</span> <span class="toc-text">注</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/25/Goole-Jetpack-Compose-Animation/" title="Google-Jetpack-Compose-Animation">Google-Jetpack-Compose-Animation</a><time datetime="2024-08-24T16:54:13.000Z" title="发表于 2024-08-25 00:54:13">2024-08-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/24/ANR03/" title="ANR-分析之基础知识介绍：event log">ANR-分析之基础知识介绍：event log</a><time datetime="2024-08-24T15:41:04.000Z" title="发表于 2024-08-24 23:41:04">2024-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/19/ANR02/" title="ANR-分析之基础知识介绍：trace信息">ANR-分析之基础知识介绍：trace信息</a><time datetime="2024-08-19T14:58:58.000Z" title="发表于 2024-08-19 22:58:58">2024-08-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/17/ANR01/" title="ANR-分类以及分析流程">ANR-分类以及分析流程</a><time datetime="2024-08-17T15:24:39.000Z" title="发表于 2024-08-17 23:24:39">2024-08-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/01/Google-App-architecture/" title="Google官方Android开发资料整理之-App architecture(架构)">Google官方Android开发资料整理之-App architecture(架构)</a><time datetime="2024-07-01T15:51:46.000Z" title="发表于 2024-07-01 23:51:46">2024-07-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2024 By 墨香</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>