<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节 | 墨香博客</title><meta name="author" content="墨香"><meta name="copyright" content="墨香"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="上一章墨香带你学Launcher之（六）- 拖拽我们介绍了Launcher的拖拽过程，涉及到的范围比较广，包括图标的拖拽，桌面上CellLayout的拖拽，小部件的拖拽，以及跨不同部件的拖拽，设计思想非常巧妙，不过整个流程相对也比较好掌握，只要跟着上一章的流程自己多跟踪几遍基本就熟悉了。按照计划本章我们继续学习Launcher的Widget的加载、添加以及Widget的大小调节。">
<meta property="og:type" content="article">
<meta property="og:title" content="墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节">
<meta property="og:url" content="http://www.codemx.cn/2016/12/18/Launcher07/index.html">
<meta property="og:site_name" content="墨香博客">
<meta property="og:description" content="上一章墨香带你学Launcher之（六）- 拖拽我们介绍了Launcher的拖拽过程，涉及到的范围比较广，包括图标的拖拽，桌面上CellLayout的拖拽，小部件的拖拽，以及跨不同部件的拖拽，设计思想非常巧妙，不过整个流程相对也比较好掌握，只要跟着上一章的流程自己多跟踪几遍基本就熟悉了。按照计划本章我们继续学习Launcher的Widget的加载、添加以及Widget的大小调节。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.codemx.cn/img/head.jpg">
<meta property="article:published_time" content="2016-12-18T03:21:03.000Z">
<meta property="article:modified_time" content="2024-07-12T16:41:32.277Z">
<meta property="article:author" content="墨香">
<meta property="article:tag" content="Launcher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.codemx.cn/img/head.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.codemx.cn/2016/12/18/Launcher07/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-13 00:41:32'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bg.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="墨香博客"><span class="site-name">墨香博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2016-12-18T03:21:03.000Z" title="发表于 2016-12-18 11:21:03">2016-12-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-12T16:41:32.277Z" title="更新于 2024-07-13 00:41:32">2024-07-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Launcher/">Launcher</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="墨香带你学Launcher之（七）- 小部件的加载、添加以及大小调节"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><blockquote>
<p>上一章<a href="http://www.codemx.cn/2016/11/21/Launcher06/">墨香带你学Launcher之（六）- 拖拽</a>我们介绍了Launcher的拖拽过程，涉及到的范围比较广，包括图标的拖拽，桌面上CellLayout的拖拽，小部件的拖拽，以及跨不同部件的拖拽，设计思想非常巧妙，不过整个流程相对也比较好掌握，只要跟着上一章的流程自己多跟踪几遍基本就熟悉了。按照计划本章我们继续学习Launcher的Widget的加载、添加以及Widget的大小调节。</p>
</blockquote>
<span id="more"></span>

<h2 id="Widget的数据加载"><a href="#Widget的数据加载" class="headerlink" title="Widget的数据加载"></a>Widget的数据加载</h2><p>其实我们在第二章<a href="http://www.codemx.cn/2016/08/05/Launcher02/">墨香带你学Launcher之（二）-数据加载流程</a>介绍过Widget数据的加载，相对只是简单的做了介绍，下面我们稍微讲的详细点。</p>
<p>我们知道Widget的数据加载开始在LauncherModel中的updateWidgetsModel方法中，我们看下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateWidgetsModel</span><span class="params">(<span class="type">boolean</span> refresh)</span> &#123;</span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">packageManager</span> <span class="operator">=</span> mApp.getContext().getPackageManager();</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Object&gt; widgetsAndShortcuts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">    widgetsAndShortcuts.addAll(getWidgetProviders(mApp.getContext(), refresh));</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">shortcutsIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_CREATE_SHORTCUT);</span><br><span class="line">    widgetsAndShortcuts.addAll(packageManager.queryIntentActivities(shortcutsIntent, <span class="number">0</span>));</span><br><span class="line">    mBgWidgetsModel.setWidgetsAndShortcuts(widgetsAndShortcuts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码我们可以看到是通过调用getWidgetProviders(mApp.getContext(), refresh)方法来获取所有Widget的，代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LauncherAppWidgetProviderInfo&gt; <span class="title function_">getWidgetProviders</span><span class="params">(Context context,</span></span><br><span class="line"><span class="params">                                                                         <span class="type">boolean</span> refresh)</span> &#123;</span><br><span class="line">        ArrayList&lt;LauncherAppWidgetProviderInfo&gt; results =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;LauncherAppWidgetProviderInfo&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (sBgLock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sBgWidgetProviders == <span class="literal">null</span> || refresh) &#123;</span><br><span class="line">                    HashMap&lt;ComponentKey, LauncherAppWidgetProviderInfo&gt; tmpWidgetProviders</span><br><span class="line">                            = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    <span class="type">AppWidgetManagerCompat</span> <span class="variable">wm</span> <span class="operator">=</span> AppWidgetManagerCompat.getInstance(context);</span><br><span class="line">                    LauncherAppWidgetProviderInfo info;</span><br><span class="line"></span><br><span class="line">                    List&lt;AppWidgetProviderInfo&gt; widgets = wm.getAllProviders();</span><br><span class="line">                    <span class="keyword">for</span> (AppWidgetProviderInfo pInfo : widgets) &#123;</span><br><span class="line">                        info = LauncherAppWidgetProviderInfo.fromProviderInfo(context, pInfo);</span><br><span class="line">                        <span class="type">UserHandleCompat</span> <span class="variable">user</span> <span class="operator">=</span> wm.getUser(info);</span><br><span class="line">                        tmpWidgetProviders.put(<span class="keyword">new</span> <span class="title class_">ComponentKey</span>(info.provider, user), info);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Collection&lt;CustomAppWidget&gt; customWidgets = Launcher.getCustomAppWidgets().values();</span><br><span class="line">                    <span class="keyword">for</span> (CustomAppWidget widget : customWidgets) &#123;</span><br><span class="line">                        info = <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetProviderInfo</span>(context, widget);</span><br><span class="line">                        <span class="type">UserHandleCompat</span> <span class="variable">user</span> <span class="operator">=</span> wm.getUser(info);</span><br><span class="line">                        tmpWidgetProviders.put(<span class="keyword">new</span> <span class="title class_">ComponentKey</span>(info.provider, user), info);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Replace the global list at the very end, so that if there is an exception,</span></span><br><span class="line">                    <span class="comment">// previously loaded provider list is used.</span></span><br><span class="line">                    sBgWidgetProviders = tmpWidgetProviders;</span><br><span class="line">                &#125;</span><br><span class="line">                results.addAll(sBgWidgetProviders.values());</span><br><span class="line">                <span class="keyword">return</span> results;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到首先是初始化AppWidgetManagerCompat，我们之前介绍过带有Compat的是兼容组件，我们看看是怎么兼容的，</p>
<p><img src="/images/launcher/image07/launcher01.png" alt="图1"></p>
<p>我们下面代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AppWidgetManagerCompat <span class="title function_">getInstance</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sInstanceLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Utilities.ATLEAST_LOLLIPOP) &#123;</span><br><span class="line">                    sInstance = <span class="keyword">new</span> <span class="title class_">AppWidgetManagerCompatVL</span>(context.getApplicationContext());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sInstance = <span class="keyword">new</span> <span class="title class_">AppWidgetManagerCompatV16</span>(context.getApplicationContext());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到AppWidgetManagerCompat的初始化有两个，一个是当Api版本高于21（包含21）时，用AppWidgetManagerCompatVL，低于21时用AppWidgetManagerCompatV16，这两个有什么不同，我们下面分析。</p>
<p>下面我们看如何获取Widget列表对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;AppWidgetProviderInfo&gt; widgets = wm.getAllProviders();</span><br></pre></td></tr></table></figure>

<p>getAllProviders()方法是一个抽象方法，所以我们看哪里进行了复写，</p>
<p><img src="/images/launcher/image07/launcher02.png" alt="图2"></p>
<p>可以看到还是上面两个兼容类复写了该方法，我们看这个两个类中做了什么处理，先看V16中的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AppWidgetProviderInfo&gt; <span class="title function_">getAllProviders</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mAppWidgetManager.getInstalledProviders();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再看mAppWidgetManager这个是在哪里初始化，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR1)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">bindAppWidgetIdIfAllowed</span><span class="params">(<span class="type">int</span> appWidgetId, AppWidgetProviderInfo info,</span></span><br><span class="line"><span class="params">        Bundle options)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Utilities.ATLEAST_JB_MR1) &#123;</span><br><span class="line">        <span class="keyword">return</span> mAppWidgetManager.bindAppWidgetIdIfAllowed(appWidgetId, info.provider, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mAppWidgetManager.bindAppWidgetIdIfAllowed(appWidgetId, info.provider);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面有个if语句，我们可以看到当Api大于等于17时，调用第一个进行初始化，否则调用第二个方法进行初始化，这就是对不同手机版本做的兼容。在我们写App的时候如果遇到相似情况也可以这么处理。</p>
<p>我们再看一下VL中的getAllProviders()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AppWidgetProviderInfo&gt; <span class="title function_">getAllProviders</span><span class="params">()</span> &#123;</span><br><span class="line">    ArrayList&lt;AppWidgetProviderInfo&gt; providers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;AppWidgetProviderInfo&gt;();</span><br><span class="line">    <span class="keyword">for</span> (UserHandle user : mUserManager.getUserProfiles()) &#123;</span><br><span class="line">        providers.addAll(mAppWidgetManager.getInstalledProvidersForProfile(user));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> providers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和V16中的不一样了，这里面是通过for循环来获取的，其中有个UserHandle，那么在源码中给出的解释是设备中的每个用户，个人理解应该是每个应用，每个应用会有0-N个Widget，也就是从每个应用中获取每个应用的Widget列表。这样for循环就可以获取整个手机中所有应用的widget列表了。</p>
<p>再回到上面getWidgetProviders方法的代码中，我们接着看，接着for循环AppWidgetProviderInfo列表信息，重构LauncherAppWidgetProviderInfo对象，这里有点怪，为啥有了AppWidgetProviderInfo对象还要重构一个LauncherAppWidgetProviderInfo对象，我们知道在写插件的时候每个Widget都会有一个类继承AppWidgetProvider，这样才会有一个插件，因此我们知道AppWidgetProviderInfo对象肯定是AppWidgetProvider的对象，那么LauncherAppWidgetProviderInfo是什么，我们接着看能不能找到答案，LauncherAppWidgetProviderInfo的初始化时通过 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LauncherAppWidgetProviderInfo.fromProviderInfo(context, pInfo);</span><br></pre></td></tr></table></figure>
<p>方法进行初始化的,我们再看LauncherAppWidgetProviderInfo又继承AppWidgetProviderInfo，越来越怪，我们接着看fromProviderInfo(context, pInfo)方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> LauncherAppWidgetProviderInfo <span class="title function_">fromProviderInfo</span><span class="params">(Context context,</span></span><br><span class="line"><span class="params">            AppWidgetProviderInfo info)</span> &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">p</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        info.writeToParcel(p, <span class="number">0</span>);</span><br><span class="line">        p.setDataPosition(<span class="number">0</span>);</span><br><span class="line">        <span class="type">LauncherAppWidgetProviderInfo</span> <span class="variable">lawpi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetProviderInfo</span>(p);</span><br><span class="line">        p.recycle();</span><br><span class="line">        <span class="keyword">return</span> lawpi;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到最后是通过new LauncherAppWidgetProviderInfo来生成一个LauncherAppWidgetProviderInfo对象，那么这个对象构造函数中有什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LauncherAppWidgetProviderInfo</span><span class="params">(Parcel in)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(in);</span><br><span class="line">    initSpans();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个构造函数调用了initSpans方法，我们接着追寻：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initSpans</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LauncherAppState</span> <span class="variable">app</span> <span class="operator">=</span> LauncherAppState.getInstance();</span><br><span class="line">        <span class="type">InvariantDeviceProfile</span> <span class="variable">idp</span> <span class="operator">=</span> app.getInvariantDeviceProfile();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We only care out the cell size, which is independent of the the layout direction.</span></span><br><span class="line">        <span class="type">Rect</span> <span class="variable">paddingLand</span> <span class="operator">=</span> idp.landscapeProfile.getWorkspacePadding(<span class="literal">false</span> <span class="comment">/* isLayoutRtl */</span>);</span><br><span class="line">        <span class="type">Rect</span> <span class="variable">paddingPort</span> <span class="operator">=</span> idp.portraitProfile.getWorkspacePadding(<span class="literal">false</span> <span class="comment">/* isLayoutRtl */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Always assume we&#x27;re working with the smallest span to make sure we</span></span><br><span class="line">        <span class="comment">// reserve enough space in both orientations.</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">smallestCellWidth</span> <span class="operator">=</span> DeviceProfile.calculateCellWidth(Math.min(</span><br><span class="line">                idp.landscapeProfile.widthPx - paddingLand.left - paddingLand.right,</span><br><span class="line">                idp.portraitProfile.widthPx - paddingPort.left - paddingPort.right),</span><br><span class="line">                idp.numColumns);</span><br><span class="line">        <span class="type">float</span> <span class="variable">smallestCellHeight</span> <span class="operator">=</span> DeviceProfile.calculateCellWidth(Math.min(</span><br><span class="line">                idp.landscapeProfile.heightPx - paddingLand.top - paddingLand.bottom,</span><br><span class="line">                idp.portraitProfile.heightPx - paddingPort.top - paddingPort.bottom),</span><br><span class="line">                idp.numRows);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We want to account for the extra amount of padding that we are adding to the widget</span></span><br><span class="line">        <span class="comment">// to ensure that it gets the full amount of space that it has requested.</span></span><br><span class="line">        <span class="type">Rect</span> <span class="variable">widgetPadding</span> <span class="operator">=</span> AppWidgetHostView.getDefaultPaddingForWidget(</span><br><span class="line">                app.getContext(), provider, <span class="literal">null</span>);</span><br><span class="line">        spanX = Math.max(<span class="number">1</span>, (<span class="type">int</span>) Math.ceil(</span><br><span class="line">                        (minWidth + widgetPadding.left + widgetPadding.right) / smallestCellWidth));</span><br><span class="line">        spanY = Math.max(<span class="number">1</span>, (<span class="type">int</span>) Math.ceil(</span><br><span class="line">                (minHeight + widgetPadding.top + widgetPadding.bottom) / smallestCellHeight));</span><br><span class="line"></span><br><span class="line">        minSpanX = Math.max(<span class="number">1</span>, (<span class="type">int</span>) Math.ceil(</span><br><span class="line">                (minResizeWidth + widgetPadding.left + widgetPadding.right) / smallestCellWidth));</span><br><span class="line">        minSpanY = Math.max(<span class="number">1</span>, (<span class="type">int</span>) Math.ceil(</span><br><span class="line">                (minResizeHeight + widgetPadding.top + widgetPadding.bottom) / smallestCellHeight));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码也不难，是为了算四个参数：spanX、spanY、minSpanX、minSpanY，看过我前面博客的都知道这个spanX和spanY参数是什么，其实这个LauncherAppWidgetProviderInfo对象比系统自带的AppWidgetProviderInfo带有的就是多了这几个参数，也就是方便我们添加到桌面是计算占用位置。</p>
<p>最后得到HashMap&lt;ComponentKey, LauncherAppWidgetProviderInfo&gt;这个Widget集合，最后通过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mBgWidgetsModel.setWidgetsAndShortcuts(widgetsAndShortcuts);</span><br></pre></td></tr></table></figure>
<p>将这个集合放到WidgetsModel中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWidgetsAndShortcuts</span><span class="params">(ArrayList&lt;Object&gt; rawWidgetsShortcuts)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        HashMap&lt;String, PackageItemInfo&gt; tmpPackageItemInfos = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clear the lists.</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="type">InvariantDeviceProfile</span> <span class="variable">idp</span> <span class="operator">=</span> LauncherAppState.getInstance().getInvariantDeviceProfile();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add and update.</span></span><br><span class="line">        <span class="keyword">for</span> (Object o: rawWidgetsShortcuts) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="type">UserHandleCompat</span> <span class="variable">userHandle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">ComponentName</span> <span class="variable">componentName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> LauncherAppWidgetProviderInfo) &#123;</span><br><span class="line">                <span class="type">LauncherAppWidgetProviderInfo</span> <span class="variable">widgetInfo</span> <span class="operator">=</span> (LauncherAppWidgetProviderInfo) o;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Ensure that all widgets we show can be added on a workspace of this size</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">minSpanX</span> <span class="operator">=</span> Math.min(widgetInfo.spanX, widgetInfo.minSpanX);</span><br><span class="line">                <span class="type">int</span> <span class="variable">minSpanY</span> <span class="operator">=</span> Math.min(widgetInfo.spanY, widgetInfo.minSpanY);</span><br><span class="line">                <span class="keyword">if</span> (minSpanX &lt;= (<span class="type">int</span>) idp.numColumns &amp;&amp;</span><br><span class="line">                    minSpanY &lt;= (<span class="type">int</span>) idp.numRows) &#123;</span><br><span class="line">                    componentName = widgetInfo.provider;</span><br><span class="line">                    packageName = widgetInfo.provider.getPackageName();</span><br><span class="line">                    userHandle = mAppWidgetMgr.getUser(widgetInfo);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ResolveInfo) &#123;</span><br><span class="line">                <span class="type">ResolveInfo</span> <span class="variable">resolveInfo</span> <span class="operator">=</span> (ResolveInfo) o;</span><br><span class="line">                componentName = <span class="keyword">new</span> <span class="title class_">ComponentName</span>(resolveInfo.activityInfo.packageName,</span><br><span class="line">                        resolveInfo.activityInfo.name);</span><br><span class="line">                packageName = resolveInfo.activityInfo.packageName;</span><br><span class="line">                userHandle = UserHandleCompat.myUserHandle();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (componentName == <span class="literal">null</span> || userHandle == <span class="literal">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="type">PackageItemInfo</span> <span class="variable">pInfo</span> <span class="operator">=</span> tmpPackageItemInfos.get(packageName);</span><br><span class="line">            ArrayList&lt;Object&gt; widgetsShortcutsList = mWidgetsList.get(pInfo);</span><br><span class="line">            <span class="keyword">if</span> (widgetsShortcutsList != <span class="literal">null</span>) &#123;</span><br><span class="line">                widgetsShortcutsList.add(o);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                widgetsShortcutsList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                widgetsShortcutsList.add(o);</span><br><span class="line">                pInfo = <span class="keyword">new</span> <span class="title class_">PackageItemInfo</span>(packageName);</span><br><span class="line">                mIconCache.getTitleAndIconForApp(packageName, userHandle,</span><br><span class="line">                        <span class="literal">true</span> <span class="comment">/* userLowResIcon */</span>, pInfo);</span><br><span class="line">                pInfo.titleSectionName = mIndexer.computeSectionName(pInfo.title);</span><br><span class="line">                mWidgetsList.put(pInfo, widgetsShortcutsList);</span><br><span class="line">                tmpPackageItemInfos.put(packageName,  pInfo);</span><br><span class="line">                mPackageItemInfos.add(pInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排序.</span></span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里将不同应用的Widget放到同一个列表中然后在放到mWidgetsList中，以供应加载Widget列表。接着执行绑定过程，绑定过程我们在第三章<a href="http://www.codemx.cn/2016/08/14/Launcher03/">墨香带你学Launcher之（三）-绑定屏幕、图标、文件夹和Widget</a>介绍过，但是里面还有些东西在这里需要介绍一下，我们看源码知道其实Widget是通过适配器放置到WidgetsRecyclerView里面的，WidgetsRecyclerView是一个RecyclerView，而每个Widget视图是一个WidgetCell，那么WidgetCell是什么，我们看WidgetsListAdapter适配器，这个我们就不详细介绍了，在里面的onBindViewHolder方法中对WidgetCell进行了初始化，其中在里面会调动下面方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">widget.applyFromAppWidgetProviderInfo(info, mWidgetPreviewLoader);</span><br></pre></td></tr></table></figure>
<p>我们看看这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applyFromAppWidgetProviderInfo</span><span class="params">(LauncherAppWidgetProviderInfo info,</span></span><br><span class="line"><span class="params">           WidgetPreviewLoader loader)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">InvariantDeviceProfile</span> <span class="variable">profile</span> <span class="operator">=</span></span><br><span class="line">               LauncherAppState.getInstance().getInvariantDeviceProfile();</span><br><span class="line">       mInfo = info;</span><br><span class="line">       <span class="comment">// TODO(hyunyoungs): setup a cache for these labels.</span></span><br><span class="line">       mWidgetName.setText(AppWidgetManagerCompat.getInstance(getContext()).loadLabel(info));</span><br><span class="line">       <span class="type">int</span> <span class="variable">hSpan</span> <span class="operator">=</span> Math.min(info.spanX, profile.numColumns);</span><br><span class="line">       <span class="type">int</span> <span class="variable">vSpan</span> <span class="operator">=</span> Math.min(info.spanY, profile.numRows);</span><br><span class="line">       mWidgetDims.setText(String.format(mDimensionsFormatString, hSpan, vSpan));</span><br><span class="line">       mWidgetPreviewLoader = loader;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>上面代码通过mWidgetName.setText显示名字，通过mWidgetDims.setText显示大小。最后给mWidgetPreviewLoader赋值，我们看到这个loader是从WidgetsListAdapter中传递进来的，在WidgetsListAdapter中，是通过LauncherAppState.getInstance().getWidgetCache()获取的，其实这个loader是在LauncherAppState初始化的时候就初始化了。</p>
<p>在WidgetCell初始化后调用了widget.ensurePreview()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ensurePreview</span><span class="params">()</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="type">int</span>[] size = getPreviewSize();</span><br><span class="line">       mActiveRequest = mWidgetPreviewLoader.getPreview(mInfo, size[<span class="number">0</span>], size[<span class="number">1</span>], <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在这里调用mWidgetPreviewLoader.getPreview方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PreviewLoadRequest <span class="title function_">getPreview</span><span class="params">(<span class="keyword">final</span> Object o, <span class="type">int</span> previewWidth,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> previewHeight, WidgetCell caller)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">size</span> <span class="operator">=</span> previewWidth + <span class="string">&quot;x&quot;</span> + previewHeight;</span><br><span class="line">    <span class="type">WidgetCacheKey</span> <span class="variable">key</span> <span class="operator">=</span> getObjectKey(o, size);</span><br><span class="line"></span><br><span class="line">    <span class="type">PreviewLoadTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreviewLoadTask</span>(key, o, previewWidth, previewHeight, caller);</span><br><span class="line">    task.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PreviewLoadRequest</span>(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里执行了一个异步任务PreviewLoadTask，我们看一下这个异步任务，首先看doInBackground方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">preview = generatePreview(launcher, mInfo, unusedBitmap, mPreviewWidth, mPreviewHeight);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>接着看generatePreview方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Bitmap <span class="title function_">generatePreview</span><span class="params">(Launcher launcher, Object info, Bitmap recycle,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> previewWidth, <span class="type">int</span> previewHeight)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (info <span class="keyword">instanceof</span> LauncherAppWidgetProviderInfo) &#123;</span><br><span class="line">        <span class="keyword">return</span> generateWidgetPreview(launcher, (LauncherAppWidgetProviderInfo) info,</span><br><span class="line">                previewWidth, recycle, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> generateShortcutPreview(launcher,</span><br><span class="line">                (ResolveInfo) info, previewWidth, previewHeight, recycle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到是生成一个Bitmap，然后调用generateWidgetPreview生成Bitmap：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Bitmap <span class="title function_">generateWidgetPreview</span><span class="params">(Launcher launcher, LauncherAppWidgetProviderInfo info,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> maxPreviewWidth, Bitmap preview, <span class="type">int</span>[] preScaledWidthOut)</span> &#123;</span><br><span class="line">        <span class="comment">// Load the preview image if possible</span></span><br><span class="line">        <span class="keyword">if</span> (maxPreviewWidth &lt; <span class="number">0</span>) maxPreviewWidth = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">        <span class="type">Drawable</span> <span class="variable">drawable</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (info.previewImage != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取相对应的drawable</span></span><br><span class="line">            drawable = mManager.loadPreview(info);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Draw the scaled preview into the final bitmap</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> (preview.getWidth() - previewWidth) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (widgetPreviewExists) &#123;</span><br><span class="line">            drawable.setBounds(x, <span class="number">0</span>, x + previewWidth, previewHeight);</span><br><span class="line">            drawable.draw(c);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; spanX; i++, tx += tileW) &#123;</span><br><span class="line">                <span class="type">float</span> <span class="variable">ty</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; spanY; j++, ty += tileH) &#123;</span><br><span class="line">                    dst.offsetTo(tx, ty);</span><br><span class="line">                    c.drawBitmap(tileBitmap, src, dst, p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Drawable</span> <span class="variable">icon</span> <span class="operator">=</span> mutateOnMainThread(mManager.loadIcon(info, mIconCache));</span><br><span class="line">                <span class="keyword">if</span> (icon != <span class="literal">null</span>) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    icon.draw(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Resources.NotFoundException e) &#123; &#125;</span><br><span class="line">            c.setBitmap(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">imageHeight</span> <span class="operator">=</span> Math.min(preview.getHeight(), previewHeight + mProfileBadgeMargin);</span><br><span class="line">        <span class="keyword">return</span> mManager.getBadgeBitmap(info, preview, imageHeight);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>整个过程就是从系统加载出Widget对应的Drawable然后绘制到Bitmap上面返回，然后在onPostExecute方法中将该图片添加到WidgetCell上面，就显示到了WidgetCell列表中。整个加载就完成了。</p>
<h2 id="Widget的添加："><a href="#Widget的添加：" class="headerlink" title="Widget的添加："></a>Widget的添加：</h2><p>我们之前讲过，Widget列表最后是绑定到WidgetsContainerView中的，而我们将Widget放置到桌面是通过长按拖拽到桌面来完成的，因此我们可以知道添加的触发事件是通过长按事件来触发的，因为我们找到WidgetsContainerView中的长按事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLongClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> beginDragging(v);</span><br><span class="line">    <span class="keyword">if</span> (status &amp;&amp; v.getTag() <span class="keyword">instanceof</span> PendingAddWidgetInfo) &#123;</span><br><span class="line">        <span class="type">WidgetHostViewLoader</span> <span class="variable">hostLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WidgetHostViewLoader</span>(mLauncher, v);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">preloadStatus</span> <span class="operator">=</span> hostLoader.preloadWidget();</span><br><span class="line">        ...</span><br><span class="line">        mLauncher.getDragController().addDragListener(hostLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先调用beginDragging方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">beginDragging</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (v <span class="keyword">instanceof</span> WidgetCell) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!beginDraggingWidget((WidgetCell) v)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Unexpected dragging view: &quot;</span> + v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don&#x27;t enter spring-loaded mode if the drag has been cancelled</span></span><br><span class="line">    <span class="keyword">if</span> (mLauncher.getDragController().isDragging()) &#123;</span><br><span class="line">        <span class="comment">// Go into spring loaded mode (must happen before we startDrag())</span></span><br><span class="line">        mLauncher.enterSpringLoadedDragMode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是Widget的视图（WidgetCell）也就是长按的是Widget布局则调用beginDraggingWidget方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">beginDraggingWidget</span><span class="params">(WidgetCell v)</span> &#123;</span><br><span class="line">        <span class="type">WidgetImageView</span> <span class="variable">image</span> <span class="operator">=</span> (WidgetImageView) v.findViewById(R.id.widget_preview);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (createItemInfo <span class="keyword">instanceof</span> PendingAddWidgetInfo) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">icon</span> <span class="operator">=</span> image.getBitmap();</span><br><span class="line">            <span class="type">float</span> <span class="variable">minScale</span> <span class="operator">=</span> <span class="number">1.25f</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">maxWidth</span> <span class="operator">=</span> Math.min((<span class="type">int</span>) (icon.getWidth() * minScale), size[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            preview = getWidgetPreviewLoader().generateWidgetPreview(mLauncher,</span><br><span class="line">                    createWidgetInfo.info, maxWidth, <span class="literal">null</span>, previewSizeBeforeScale);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            scale = bounds.width() / (<span class="type">float</span>) preview.getWidth();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// shortcut</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don&#x27;t clip alpha values for the drag outline if we&#x27;re using the default widget preview</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">clipAlpha</span> <span class="operator">=</span> !(createItemInfo <span class="keyword">instanceof</span> PendingAddWidgetInfo &amp;&amp;</span><br><span class="line">                (((PendingAddWidgetInfo) createItemInfo).previewImage == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the drag</span></span><br><span class="line">        mLauncher.lockScreenOrientation();</span><br><span class="line">        mLauncher.getWorkspace().onDragStartedWithItem(createItemInfo, preview, clipAlpha);</span><br><span class="line">        mDragController.startDrag(image, preview, <span class="built_in">this</span>, createItemInfo,</span><br><span class="line">                bounds, DragController.DRAG_ACTION_COPY, scale);</span><br><span class="line"></span><br><span class="line">        preview.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中的generateWidgetPreview方法我们在上面已经讲过了，就是生产WidgetCell图片的，然后锁定屏幕旋转，然后调用onDragStartedWithItem方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDragStartedWithItem</span><span class="params">(PendingAddItemInfo info, Bitmap b, <span class="type">boolean</span> clipAlpha)</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] size = estimateItemSize(info, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The outline is used to visualize where the item will land if dropped</span></span><br><span class="line">    mDragOutline = createDragOutline(b, DRAG_BITMAP_PADDING, size[<span class="number">0</span>], size[<span class="number">1</span>], clipAlpha);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个方法在拖拽中讲过，就是在workspace中生成一个拖拽view的轮廓边框，然后调用mDragController.startDrag方法，之后的过程在拖拽章节中有很详细的讲解，所以在此不再重复了，没看过拖拽的可以去看拖拽过程详解。下面只是个提示过程。</p>
<p>在放置到桌面时会调用onDrop方法，然后调用onDropExternal方法，然后调用addPendingItem方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPendingItem</span><span class="params">(PendingAddItemInfo info, <span class="type">long</span> container, <span class="type">long</span> screenId,</span></span><br><span class="line"><span class="params">                               <span class="type">int</span>[] cell, <span class="type">int</span> spanX, <span class="type">int</span> spanY)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (info.itemType) &#123;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET:</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:</span><br><span class="line">                <span class="type">int</span> span[] = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];</span><br><span class="line">                span[<span class="number">0</span>] = spanX;</span><br><span class="line">                span[<span class="number">1</span>] = spanY;</span><br><span class="line">                addAppWidgetFromDrop((PendingAddWidgetInfo) info,</span><br><span class="line">                        container, screenId, cell, span);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果是Widget则调用addAppWidgetFromDrop方法，然后调用addAppWidgetImpl方法，然后调用completeAddAppWidget方法，最后调用mWorkspace.addInScreen方法就讲WidgetCell添加到了桌面上。</p>
<h2 id="Widget的大小调节："><a href="#Widget的大小调节：" class="headerlink" title="Widget的大小调节："></a>Widget的大小调节：</h2><p>我们在桌面上添加完Widget后，如果长按你会发现在Widget四个边缘会出现拖动框，如果拖动可以调节小插件的大小，那么这个拖动框在哪里添加的呢，我们看一下，其实这个方法是DragLayer中的addResizeFrame方法，这个方法是在Workspace中的onDrop方法中调用的，也就是放到桌面上的时候就添加了。</p>
<p>我们看一下这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResizeFrame</span><span class="params">(ItemInfo itemInfo, LauncherAppWidgetHostView widget,</span></span><br><span class="line"><span class="params">            CellLayout cellLayout)</span> &#123;</span><br><span class="line">        <span class="type">AppWidgetResizeFrame</span> <span class="variable">resizeFrame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppWidgetResizeFrame</span>(getContext(),</span><br><span class="line">                widget, cellLayout, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">LayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LayoutParams</span>(-<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">        lp.customPosition = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        addView(resizeFrame, lp);</span><br><span class="line">        mResizeFrames.add(resizeFrame);</span><br><span class="line"></span><br><span class="line">        resizeFrame.snapToWidget(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先创建AppWidgetResizeFrame对象，传入参数LauncherAppWidgetHostView、CellLayout，还有draglayer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AppWidgetResizeFrame</span><span class="params">(Context context,</span></span><br><span class="line"><span class="params">        LauncherAppWidgetHostView widgetView, CellLayout cellLayout, DragLayer dragLayer)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化数据</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化左侧拖动点</span></span><br><span class="line">    mLeftHandle = <span class="keyword">new</span> <span class="title class_">ImageView</span>(context);</span><br><span class="line">    mLeftHandle.setImageResource(R.drawable.ic_widget_resize_handle);</span><br><span class="line">    lp = <span class="keyword">new</span> <span class="title class_">LayoutParams</span>(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT,</span><br><span class="line">            Gravity.LEFT | Gravity.CENTER_VERTICAL);</span><br><span class="line">    lp.leftMargin = handleMargin;</span><br><span class="line">    addView(mLeftHandle, lp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化右侧拖动点</span></span><br><span class="line">    <span class="comment">// 初始化顶部拖动点</span></span><br><span class="line">    <span class="comment">// 初始化底部拖动点</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拖动调整大小是在DragLayer中的onTouchEvent方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mCurrentResizeFrame != <span class="literal">null</span>) &#123;</span><br><span class="line">        handled = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                mCurrentResizeFrame.visualizeResizeForDelta(x - mXDown, y - mYDown);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                mCurrentResizeFrame.visualizeResizeForDelta(x - mXDown, y - mYDown);</span><br><span class="line">                mCurrentResizeFrame.onTouchUp();</span><br><span class="line">                mCurrentResizeFrame = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handled) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> mDragController.onTouchEvent(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上面代码可以看出拖拽的的时候调用visualizeResizeForDelta方法，手指抬起的时候调用visualizeResizeForDelta方法和onTouchUp方法，我们先看visualizeResizeForDelta方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">visualizeResizeForDelta</span><span class="params">(<span class="type">int</span> deltaX, <span class="type">int</span> deltaY, <span class="type">boolean</span> onDismiss)</span> &#123;</span><br><span class="line">      updateDeltas(deltaX, deltaY);</span><br><span class="line">      DragLayer.<span class="type">LayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> (DragLayer.LayoutParams) getLayoutParams();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mLeftBorderActive) &#123;</span><br><span class="line">          lp.x = mBaselineX + mDeltaX;</span><br><span class="line">          lp.width = mBaselineWidth - mDeltaX;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mRightBorderActive) &#123;</span><br><span class="line">          lp.width = mBaselineWidth + mDeltaX;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mTopBorderActive) &#123;</span><br><span class="line">          lp.y = mBaselineY + mDeltaY;</span><br><span class="line">          lp.height = mBaselineHeight - mDeltaY;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mBottomBorderActive) &#123;</span><br><span class="line">          lp.height = mBaselineHeight + mDeltaY;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      resizeWidgetIfNeeded(onDismiss);</span><br><span class="line">      requestLayout();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>首先调用updateDeltas方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDeltas</span><span class="params">(<span class="type">int</span> deltaX, <span class="type">int</span> deltaY)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mLeftBorderActive) &#123;</span><br><span class="line">        mDeltaX = Math.max(-mBaselineX, deltaX); </span><br><span class="line">        mDeltaX = Math.min(mBaselineWidth - <span class="number">2</span> * mTouchTargetWidth, mDeltaX);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mRightBorderActive) &#123;</span><br><span class="line">        mDeltaX = Math.min(mDragLayer.getWidth() - (mBaselineX + mBaselineWidth), deltaX);</span><br><span class="line">        mDeltaX = Math.max(-mBaselineWidth + <span class="number">2</span> * mTouchTargetWidth, mDeltaX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTopBorderActive) &#123;</span><br><span class="line">        mDeltaY = Math.max(-mBaselineY, deltaY);</span><br><span class="line">        mDeltaY = Math.min(mBaselineHeight - <span class="number">2</span> * mTouchTargetWidth, mDeltaY);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mBottomBorderActive) &#123;</span><br><span class="line">        mDeltaY = Math.min(mDragLayer.getHeight() - (mBaselineY + mBaselineHeight), deltaY);</span><br><span class="line">        mDeltaY = Math.max(-mBaselineHeight + <span class="number">2</span> * mTouchTargetWidth, mDeltaY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是根据上下左右点来计算mDeltaX和mDeltaY的值，然后设定DragLayer.LayoutParams的值，然后调用resizeWidgetIfNeeded方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resizeWidgetIfNeeded</span><span class="params">(<span class="type">boolean</span> onDismiss)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mLeftBorderActive) &#123;</span><br><span class="line">            cellXInc = Math.max(-cellX, hSpanInc);</span><br><span class="line">            cellXInc = Math.min(lp.cellHSpan - mMinHSpan, cellXInc);</span><br><span class="line">            hSpanInc *= -<span class="number">1</span>;</span><br><span class="line">            hSpanInc = Math.min(cellX, hSpanInc);</span><br><span class="line">            hSpanInc = Math.max(-(lp.cellHSpan - mMinHSpan), hSpanInc);</span><br><span class="line">            hSpanDelta = -hSpanInc;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update the widget&#x27;s dimensions and position according to the deltas computed above</span></span><br><span class="line">        <span class="keyword">if</span> (mLeftBorderActive || mRightBorderActive) &#123;</span><br><span class="line">            spanX += hSpanInc;</span><br><span class="line">            cellX += cellXInc;</span><br><span class="line">            <span class="keyword">if</span> (hSpanDelta != <span class="number">0</span>) &#123;</span><br><span class="line">                mDirectionVector[<span class="number">0</span>] = mLeftBorderActive ? -<span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCellLayout.createAreaForResize(cellX, cellY, spanX, spanY, mWidgetView,</span><br><span class="line">                mDirectionVector, onDismiss)) &#123;</span><br><span class="line">            lp.tmpCellX = cellX;</span><br><span class="line">            lp.tmpCellY = cellY;</span><br><span class="line">            lp.cellHSpan = spanX;</span><br><span class="line">            lp.cellVSpan = spanY;</span><br><span class="line">            mRunningVInc += vSpanDelta;</span><br><span class="line">            mRunningHInc += hSpanDelta;</span><br><span class="line">            <span class="keyword">if</span> (!onDismiss) &#123;</span><br><span class="line">                updateWidgetSizeRanges(mWidgetView, mLauncher, spanX, spanY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mWidgetView.requestLayout();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里计算拖拽过程中的参数，然后调用updateWidgetSizeRanges方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateWidgetSizeRanges</span><span class="params">(AppWidgetHostView widgetView, Launcher launcher,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> spanX, <span class="type">int</span> spanY)</span> &#123;</span><br><span class="line">    getWidgetSizeRanges(launcher, spanX, spanY, sTmpRect);</span><br><span class="line">    widgetView.updateAppWidgetSize(<span class="literal">null</span>, sTmpRect.left, sTmpRect.top,</span><br><span class="line">            sTmpRect.right, sTmpRect.bottom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先调用getWidgetSizeRanges方法来设定sTmpRect参数，然后调用widgetView.updateAppWidgetSize方法更新widget大小，然后调用mWidgetView.requestLayout方法刷新widget。</p>
<p>我们再看onTouchUp方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTouchUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">xThreshold</span> <span class="operator">=</span> mCellLayout.getCellWidth() + mCellLayout.getWidthGap();</span><br><span class="line">    <span class="type">int</span> <span class="variable">yThreshold</span> <span class="operator">=</span> mCellLayout.getCellHeight() + mCellLayout.getHeightGap();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            snapToWidget(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法是调整完widget大小手指离开屏幕时调用的，主要调用了snapToWidget方法，这个方法代码就不贴了，主要是四个点的动画，代码很简单。</p>
<p>到此widget的加载、添加以及大小调整就介绍完了，整个过程也是比较复杂的，所以还是要好好熟悉一下。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>Github地址：<a target="_blank" rel="noopener" href="https://github.com/yuchuangu85/Launcher3_mx/tree/launcher3_6.0">https://github.com/yuchuangu85/Launcher3_mx&#x2F;tree&#x2F;launcher3_6.0</a></p>
<p>Android开发群：192508518</p>
<p>微信公众账号：Code-MX<br><img src="/images/codemx/qr_code_mx.jpg" alt="qr_code_mx"></p>
<p>注：本文原创，转载请注明出处，多谢。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://www.codemx.cn">墨香</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://www.codemx.cn/2016/12/18/Launcher07/">http://www.codemx.cn/2016/12/18/Launcher07/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.codemx.cn" target="_blank">墨香博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Launcher/">Launcher</a></div><div class="post-share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2017/01/10/FrameCollection/" title="Android 常用框架集合"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 常用框架集合</div></div></a><a class="next-post pull-right" href="/2016/11/21/Launcher06/" title="墨香带你学Launcher之（六）- 拖拽"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">墨香带你学Launcher之（六）- 拖拽</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2016/07/30/Launcher01/" title="墨香带你学Launcher之（一）- 概述"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-07-30</div><div class="title">墨香带你学Launcher之（一）- 概述</div></div></a><a href="/2016/08/14/Launcher03/" title="墨香带你学Launcher之（三）- 绑定屏幕、图标、文件夹和Widget"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-08-14</div><div class="title">墨香带你学Launcher之（三）- 绑定屏幕、图标、文件夹和Widget</div></div></a><a href="/2016/08/05/Launcher02/" title="墨香带你学Launcher之（二）- 数据加载流程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-08-05</div><div class="title">墨香带你学Launcher之（二）- 数据加载流程</div></div></a><a href="/2016/08/21/Launcher04/" title="墨香带你学Launcher之（四）- 应用安装、更新、卸载时的数据加载"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-08-21</div><div class="title">墨香带你学Launcher之（四）- 应用安装、更新、卸载时的数据加载</div></div></a><a href="/2016/10/16/Launcher05/" title="墨香带你学Launcher之（五）- Workspace滑动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-10-16</div><div class="title">墨香带你学Launcher之（五）- Workspace滑动</div></div></a><a href="/2016/11/21/Launcher06/" title="墨香带你学Launcher之（六）- 拖拽"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-11-21</div><div class="title">墨香带你学Launcher之（六）- 拖拽</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">墨香</div><div class="author-info-description">因为兴趣所以选择，因为选择所以坚持。</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yuchuangu85"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/yuchuangu85" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yuchuangu85@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">路虽远，行则将至；事虽难，做则可成。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Widget%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.</span> <span class="toc-text">Widget的数据加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Widget%E7%9A%84%E6%B7%BB%E5%8A%A0%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">Widget的添加：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Widget%E7%9A%84%E5%A4%A7%E5%B0%8F%E8%B0%83%E8%8A%82%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">Widget的大小调节：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">4.</span> <span class="toc-text">最后</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/24/ANR03/" title="ANR-分析之基础知识介绍：event log">ANR-分析之基础知识介绍：event log</a><time datetime="2024-08-24T15:41:04.000Z" title="发表于 2024-08-24 23:41:04">2024-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/19/ANR02/" title="ANR-分析之基础知识介绍：trace信息">ANR-分析之基础知识介绍：trace信息</a><time datetime="2024-08-19T14:58:58.000Z" title="发表于 2024-08-19 22:58:58">2024-08-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/17/ANR01/" title="ANR-分类以及分析流程">ANR-分类以及分析流程</a><time datetime="2024-08-17T15:24:39.000Z" title="发表于 2024-08-17 23:24:39">2024-08-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/01/Google-App-architecture/" title="Google官方Android开发资料整理之-App architecture(架构)">Google官方Android开发资料整理之-App architecture(架构)</a><time datetime="2024-07-01T15:51:46.000Z" title="发表于 2024-07-01 23:51:46">2024-07-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/01/Kotlin-Coroutines/" title="Kotlin-Coroutines">Kotlin-Coroutines</a><time datetime="2024-07-01T15:41:34.000Z" title="发表于 2024-07-01 23:41:34">2024-07-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2024 By 墨香</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>